<!DOCTYPE html>
<html data-html-server-rendered="true" lang="fr" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22fr%22%7D%7D">
  <head>
    <title>Cr√©er une API RESTful sur Go - https://etienner.github.io</title><meta name="gridsome:hash" content="321f72ea5ea99330a789cb374431474c20a110a9"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.14"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" name="description" content="Une API (Application Programming Interface) permet de fournir des donn√©es brutes accessibles depuis une URL. En g√©n√©ral, cela permet de faire le pont entre une application cliente et une base de donn√©es"><meta data-vue-tag="ssr" property="og:type" content="article"><meta data-vue-tag="ssr" property="og:title" content="Cr√©er une API RESTful sur Go"><meta data-vue-tag="ssr" property="og:description" content="Une API (Application Programming Interface) permet de fournir des donn√©es brutes accessibles depuis une URL. En g√©n√©ral, cela permet de faire le pont entre une application cliente et une base de donn√©es"><meta data-vue-tag="ssr" property="og:url" content="https://etienner.github.io/creer-une-api-res-tful-sur-go/"><meta data-vue-tag="ssr" name="twitter:domain" content="https://etienner.github.io"><meta data-vue-tag="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-tag="ssr" name="twitter:title" content="Cr√©er une API RESTful sur Go"><meta data-vue-tag="ssr" name="twitter:description" content="Une API (Application Programming Interface) permet de fournir des donn√©es brutes accessibles depuis une URL. En g√©n√©ral, cela permet de faire le pont entre une application cliente et une base de donn√©es"><meta data-vue-tag="ssr" name="twitter:site" content="@etiennerouzeaud"><meta data-vue-tag="ssr" name="twitter:creator" content="@etiennerouzeaud"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/assets/static/favicon.62d22cb.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/assets/static/favicon.1539b60.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/assets/static/favicon.dc0cdc5.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/static/favicon.7b22250.9bb7ffafafc09ac851d81afb65b8ef59.png"><link rel="preload" href="/assets/css/0.styles.c2df4604.css" as="style"><link rel="preload" href="/assets/js/app.cbba8dfd.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--post-vue.7a1fe054.js" as="script"><link rel="prefetch" href="/assets/js/page--node-modules--gridsome--app--pages--404-vue.77a6618c.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.dfbaccb8.js"><link rel="prefetch" href="/assets/js/page--src--templates--tag-vue.37769e18.js"><link rel="stylesheet" href="/assets/css/0.styles.c2df4604.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div data-server-rendered="true" id="app"><header class="py-2 text-center"><strong><a href="/" title="Accueil" class="active">Etienne ROUZEAUD - D√©veloppeur Web</a></strong></header><main><div class="title py-2 text-center" data-v-2084d89c><h1 class="display-5 pt-2" data-v-2084d89c>Cr√©er une API RESTful sur Go</h1><!----></div><div class="container"><div class="row sidebar"><div class="mt-4 col-lg-2"><p><em><span>24 f√©vrier 2017</span></em></p><ul class="list-unstyled"><li>
            üè∑Ô∏è <a href="/tag/Golang/">Golang</a></li><li>
            üè∑Ô∏è <a href="/tag/API/">API</a></li></ul><p><a href="https://github.com/EtienneR/go_sqlite_api" target="_blank" rel="noopener">
            üíæ T√©l√©chargement
          </a></p></div><div class="col-lg-10 mt-4"><!----><article><p>Une API (Application Programming Interface) permet de fournir des donn√©es brutes accessibles depuis une URL. En g√©n√©ral, cela permet de faire le pont entre une application cliente et une base de donn√©es, dans notre cas depuis SQLite. Pourquoi le choix de cette base ? Car SQLite est un syst√®me de base de donn√©es en SQL qui a pour principal atout de fonctionner sans serveur car les donn√©es sont contenues dans un fichier. Avec certes moins d'options mais cela est suffisant dans notre cas.</p>
<p>Dans l'API que nous allons mettre en place, les donn√©es seront fournies √† l'utilisateur final au format JSON (JavaScript Object Notation). Nous allons aussi r√©aliser des tests unitaires et configurer le serveur afin qu'il soit accessible pour les navigateurs Internet.</p>
<p>Pr√©requis n√©cessaires :</p>
<ul>
<li>Go et Git install√©s ;</li>
<li>Avoir des bases en Go ;</li>
<li>Notions de requ√™tes CRUD en SQL et en HTTP;</li>
</ul>
<p>Pr√©requis optionnels :</p>
<ul>
<li>Avoir lu ce tutoriel : <a href="http://zestedesavoir.com/tutoriels/299/la-theorie-rest-restful-et-hateoas" target="_blank" rel="nofollow noopener noreferrer">http://zestedesavoir.com/tutoriels/299/la-theorie-rest-restful-et-hateoas</a> ;</li>
<li>L'application <a href="https://www.getpostman.com" target="_blank" rel="nofollow noopener noreferrer">Postman</a> install√©e.</li>
</ul>
<p>Objectifs :</p>
<ul>
<li>Cr√©er une API RESTful sur Go avec des requ√™tes en SQL via un ORM ;</li>
<li>R√©aliser des tests fonctionnels et unitaires ;</li>
<li>Configurer CORS, OPTIONS, ajouter un token d'authentification.</li>
</ul>
<h2>Pr√©paration du dossier de travail</h2>
<p>Dans votre dossier "gopath" (<code class="language-text">%gopath%</code> sur Windows, <code class="language-text">$GOPATH</code> sur Linux et MacOS), dans le dossier "src" puis "github.com", votre nom d'utilisateur (dans ce tutoriel, ce sera "EtienneR") et cr√©ez un nouveau dossier ("go_sqlite_api" dans ce tutoriel). Le dossier de notre projet va comporter un fichier "main.go" contenant notre serveur et un dossier "api" avec les fichiers "api.go", "users.go" et le fichier de tests unitaires "users_test.go". Par la suite, le fichier SQLite "data.db" sera cr√©√© automatiquement.</p>
<div class="gridsome-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">gopath/
  src/
    github.com/
        EtienneR/
            go_sqlite_api/
                api/
                    api.go
                    users.go
                    users_test.go
                main.go
                data.db</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Les librairies</h3>
<p>Pour mettre en place cette API, on a besoin des 3 librairies ci-dessous.</p>
<ul>
<li>Gin : le micro framework bas√© sur HttpRouter <code class="language-text">go get github.com/gin-gonic/gin</code> ;</li>
<li>go-sqlite3 : le "driver" (pilote en fran√ßais) SQLite3 <code class="language-text">go get github.com/mattn/go-sqlite3</code> ;</li>
<li>Gorm : l'ORM (Object-Relational Mapping) <code class="language-text">go get github.com/jinzhu/gorm</code>.</li>
</ul>
<p>Dans le fichier "api.go", on appel ces librairies dans "import".</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">package</span> api

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/gin-gonic/gin"</span>
    <span class="token string">"github.com/jinzhu/gorm"</span>
    <span class="token boolean">_</span> <span class="token string">"github.com/mattn/go-sqlite3"</span>
<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Remarque : le pilote SQLite3 est indispensable pour faire fonctionner l'ORM. Gorm accepte √©galement <strong>MySQL</strong> (et <strong>MariaDB</strong>), <strong>Postgres</strong> et <strong>FoundationDB</strong> √† condition d'avoir √† disposition le pilote correspondant.</p>
<h3>Pr√©paration de la base de donn√©es</h3>
<p>Pour cr√©er notre futur fichier de base de donn√©e SQLite "data.db", on va avoir recours √† l'ORM, Gorm.</p>
<h4>Structure de donn√©es</h4>
<p>Pour la structure dans notre fichier "users.go", on reprend le nom de la table concern√©e "users" ainsi que les 2 champs "id" et "name".</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">package</span> api

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/gin-gonic/gin"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Users <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Id   <span class="token builtin">int</span>    <span class="token string">`gorm:"AUTO_INCREMENT" form:"id" json:"id"`</span>
    Name <span class="token builtin">string</span> <span class="token string">`gorm:"not null" form:"name" json:"name"`</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>On met en place le "databinding" pour les donn√©es rentr√©es (POST et PUT) avec <code class="language-text">json:&quot;id&quot;</code> et <code class="language-text">json:&quot;name&quot;</code>. Si cette notion vous parait abstraite, vous comprendrez son principe lors de l'utilisation des routes concern√©es. Concernant <code class="language-text">form:&quot;id&quot;</code> et <code class="language-text">form:&quot;name&quot;</code>, ils permettent de r√©cup√©rer les donn√©es depuis "form-data" et "x-www-form-urlencoded" disponibles dans Postman. Quant √† "gorm", ce sont des param√™tres de configuration d√©di√©s √† la cr√©ation des champs concern√©s.`</p>
<h4>Initialisation de la base de donn√©es</h4>
<p>Pour se connecter √† la base de donn√©es, dans le fichier "api.go", on indique le pilote utilis√© "sqlite3" et le chemin du fichier "data.db".</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">func</span> <span class="token function">InitDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
    <span class="token comment">// Ouverture du fichier</span>
    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"sqlite3"</span><span class="token punctuation">,</span> <span class="token string">"./data.db"</span><span class="token punctuation">)</span>
    db<span class="token punctuation">.</span><span class="token function">LogMode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>

    <span class="token comment">// Cr√©ation de la table</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>db<span class="token punctuation">.</span><span class="token function">HasTable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Users<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        db<span class="token punctuation">.</span><span class="token function">CreateTable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Users<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        db<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"gorm:table_options"</span><span class="token punctuation">,</span> <span class="token string">"ENGINE=InnoDB"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateTable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Users<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Erreur de chargement</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> db
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Dans la premi√®re condition, si la table "users" n'existe pas, alors on l'a cr√©√© avec les options d√©clar√©es dans la structure "Users" ainsi que le moteur SQL "InnoDB".<br>
La fonction facultative mais utile en phase de d√©veloppement <code class="language-text">db.LogMode(true)</code> permet d'afficher la ou les requ√™te(s) effectu√©e(s) dans le terminal.</p>
<h3>Cr√©ation du serveur</h3>
<p>Dans le fichier "main.go", on d√©ploit un serveur HTTP fonctionnant sur le port 3000 et dont les routes seront d√©clar√©es dans le package "api", dans le fichier "api.go".</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"log"</span>
    <span class="token string">"net/http"</span>

    <span class="token string">"github.com/EtienneR/go_sqlite_api/api"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">":3000"</span><span class="token punctuation">,</span> api<span class="token punctuation">.</span><span class="token function">Handlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"ListenAndServe: "</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Remarque : en production, il faudra remplacer le port 3000 par 80.</p>
<p>Vous l'avez compris, √† ce stade, le serveur ne fonctionne pas car on n'a pas encore travaill√© dans le fichier "api.go". On ne touchera plus au fichier "main.go".</p>
<h2>Le routage</h2>
<p>Dans cette partie, on va faire le plus gros, c'est-√†-dire d√©clarer nos routes avec les requ√™tes SQL correspondantes en prenant soin de prendre en compte les erreurs √©ventuelles qui surviennent lors de l'appelation et l'envoi des donn√©es. Nous testerons nos routes avec Postman sauf si vous pr√©f√©rez CURL et sa syntaxe...</p>
<h3>Objectifs</h3>
<p>On va utiliser 5 routes basiques de CRUD (Create, Read, Update, Delete) list√©es ci-dessous.</p>
<table>
<thead>
<tr>
<th>Verbe</th>
<th>URL</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/api/v1/users</td>
<td>Lister tous les utilisateurs</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/users/1</td>
<td>Lister l'utilisateur #1</td>
</tr>
<tr>
<td>POST</td>
<td>/api/v1/users</td>
<td>Poster un nouvel utilisateur</td>
</tr>
<tr>
<td>PUT</td>
<td>/api/v1/users/1</td>
<td>Modifier l'utilisateur #1</td>
</tr>
<tr>
<td>DELETE</td>
<td>/api/v1/users/1</td>
<td>l'utilisateur #1</td>
</tr>
</tbody>
</table>
<h3>Pr√©paration</h3>
<p>A la suite (dans le fichier "api.go"), dans une nouvelle fonction nomm√©e <code class="language-text">Handlers()</code>, on fait appel au micro-framework Gin pour d√©clarer nos routes.</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">func</span> <span class="token function">Handlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine <span class="token punctuation">{</span>
    r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    v1Users <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"api/v1/users"</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        v1Users<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> PostUser<span class="token punctuation">)</span>
        v1Users<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> GetUsers<span class="token punctuation">)</span>
        v1Users<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">":id"</span><span class="token punctuation">,</span> GetUser<span class="token punctuation">)</span>
        v1Users<span class="token punctuation">.</span><span class="token function">PUT</span><span class="token punctuation">(</span><span class="token string">":id"</span><span class="token punctuation">,</span> EditUser<span class="token punctuation">)</span>
        v1Users<span class="token punctuation">.</span><span class="token function">DELETE</span><span class="token punctuation">(</span><span class="token string">":id"</span><span class="token punctuation">,</span> DeleteUser<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> r
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Dans un premier temps, on instancie le serveur MUX dans une variable (r). Sachant que les URL de notre API commencent par le m√™me chemin, le "endpoint" <code class="language-text">api/v1/users</code>, on d√©clare un groupe pour nos routes dans une variable (<code class="language-text">v1Users</code>). C'est dans cette fonction que l'on placera nos routes. Et on retourne les donn√©es de notre routeur MUX car on en a besoin dans notre fichier "main.go". Pour mieux organiser notre code, nous allons cr√©er les fonctions de nos routes dans le fichier "users.go".</p>
<h3>Ajouter un nouvel utilisateur</h3>
<p>Pour ins√©rer des donn√©es, on veut effectuer la requ√™te SQL semblable √† celle ci-dessous.</p>
<div class="gridsome-highlight" data-language="sql"><pre style="counter-reset: linenumber NaN" class="language-sql line-numbers"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token string">"users"</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">"toto"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>On met en place une route de type POST dans la fonction <code class="language-text">PostUser</code>.</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token comment">// Ajouter un utilisteur</span>
<span class="token keyword">func</span> <span class="token function">PostUser</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    db <span class="token operator">:=</span> <span class="token function">InitDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">var</span> json Users
    c<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>json<span class="token punctuation">)</span>

    <span class="token comment">// Si le champ est bien saisi</span>
    <span class="token keyword">if</span> json<span class="token punctuation">.</span>Name <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
        <span class="token comment">// INSERT INTO "users" (name) VALUES (json.Name);</span>
        db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>json<span class="token punctuation">)</span>
        <span class="token comment">// Affichage des donn√©es saisies</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"success"</span><span class="token punctuation">:</span> json<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Affichage de l'erreur</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">422</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Fields are empty"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Dans un premier temps, on r√©cup√®re les donn√©es rentr√©es en JSON via la fonction <code class="language-text">c.Bind()</code>. Puis on v√©rifie si le champ "name" n'est pas vide alors on envoie un message de succ√®s avec le code HTTP "201". Sinon on renvoie le code "422" avec un message d'erreur.</p>
<p>Dans Postman, s√©lectionnez "POST" puis l'URL "<a href="http://localhost:3000/api/v1/users" target="_blank" rel="nofollow noopener noreferrer">http://localhost:3000/api/v1/users</a>", cochez "Body" puis "raw", s√©lectionnez "JSON (application/json)" et copiez les donn√©es √† rentrer <code class="language-text">{ &quot;name&quot;: &quot;John Doe&quot; }</code> et cliquez sur "Send".</p>
<p>Attention : pour que "form-data" et "x-www-form-urlencoded" fonctionnent correctement, il ne faut pas qu'il y'ait d'en-t√™tes HTTP dans "Headers".</p>
<h3>Lister tous les utilisateurs</h3>
<p>On veut afficher dans un tableau JSON tous les utilisateurs pr√©sents dans la table "users" ce qui revient √† faire en SQL.</p>
<div class="gridsome-highlight" data-language="sql"><pre style="counter-reset: linenumber NaN" class="language-sql line-numbers"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>On met en place une route de type GET dans la fonction <code class="language-text">GetUsers</code>.`</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token comment">// Obtenir la liste de tous les utilisateurs</span>
<span class="token keyword">func</span> <span class="token function">GetUsers</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    db <span class="token operator">:=</span> <span class="token function">InitDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">var</span> users <span class="token punctuation">[</span><span class="token punctuation">]</span>Users
    <span class="token comment">// SELECT * FROM users</span>
    db<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
    <span class="token comment">// Affichage des donn√©es</span>
    c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> users<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>On cr√©√© une variable <code class="language-text">users</code> h√©rit√©e de la structure du m√™me nom en pr√©cisant que l'on souhaite un tableau (crochets ouvrant et fermant). Puis on effectue la requ√™te SQL et on appel le r√©sultat dans un appel au format JSON via la fonction <code class="language-text">c.JSON()</code>.</p>
<h3>Lister un utilisateur</h3>
<p>On veut afficher les donn√©es d'un utilisateur ce qui revient √† faire en SQL.</p>
<div class="gridsome-highlight" data-language="sql"><pre style="counter-reset: linenumber NaN" class="language-sql line-numbers"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>On met en place une route de type GET avec l'id en param√®tre dans la fonction <code class="language-text">GetUser</code>.</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token comment">// Obtenir un utilisateur par son id</span>
<span class="token keyword">func</span> <span class="token function">GetUser</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    db <span class="token operator">:=</span> <span class="token function">InitDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    id <span class="token operator">:=</span> c<span class="token punctuation">.</span>Params<span class="token punctuation">.</span><span class="token function">ByName</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> user Users
    <span class="token comment">// SELECT * FROM users WHERE id = 1;</span>
    db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> id<span class="token punctuation">)</span>

    <span class="token keyword">if</span> user<span class="token punctuation">.</span>Id <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token comment">// Affichage des donn√©es</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Affichage de l'erreur</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"User not found"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Dans un premier temps, on stocke l'id concern√© dans la variable <code class="language-text">id</code> via la fonction <code class="language-text">c.Params.ByName(&quot;id&quot;)</code>. Puis on v√©rifie que la requ√™te SQL renvoie un r√©sultat dans une ligne sinon on affiche une erreur 404 avec un message d'erreur personnalis√©.`</p>
<h3>Modifier un utilisateur</h3>
<p>Pour modifier des donn√©es, on veut effectuer la requ√™te SQL.</p>
<div class="gridsome-highlight" data-language="sql"><pre style="counter-reset: linenumber NaN" class="language-sql line-numbers"><code class="language-sql"><span class="token keyword">UPDATE</span> users <span class="token keyword">SET</span> name<span class="token operator">=</span><span class="token string">'toto2'</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>On met en place une route de type PUT avec l'id en param√®tre dans la fonction <code class="language-text">EditUser</code>.</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token comment">// Modifier un utilisateur</span>
<span class="token keyword">func</span> <span class="token function">EditUser</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    db <span class="token operator">:=</span> <span class="token function">InitDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    id <span class="token operator">:=</span> c<span class="token punctuation">.</span>Params<span class="token punctuation">.</span><span class="token function">ByName</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> user Users
    <span class="token comment">// SELECT * FROM users WHERE id = 1;</span>
    db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> id<span class="token punctuation">)</span>

    <span class="token keyword">if</span> user<span class="token punctuation">.</span>Name <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> user<span class="token punctuation">.</span>Id <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> json Users
            c<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>json<span class="token punctuation">)</span>

            result <span class="token operator">:=</span> Users<span class="token punctuation">{</span>
                Id<span class="token punctuation">:</span>   user<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
                Name<span class="token punctuation">:</span> json<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// UPDATE users SET name='json.Name' WHERE id = user.Id;</span>
            db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
            <span class="token comment">// Affichage des donn√©es modifi√©es</span>
            c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"success"</span><span class="token punctuation">:</span> result<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Affichage de l'erreur</span>
            c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"User not found"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Affichage de l'erreur</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">422</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Fields are empty"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Dans un premier temps, on stocke l'id concern√© dans la variable <code class="language-text">id</code> via la fonction <code class="language-text">c.Params.ByName(&quot;id&quot;)</code>. Comme dans la fonction pr√©c√©dente, on v√©rifie si le champ "name" n'est pas vide alors on envoie les donn√©es avec un message de succ√®s de code HTTP "201". Sinon on renvoie une erreur "422" avec un message d'erreur. Puis on v√©rifie que la requ√™te SQL renvoie un r√©sultat, sinon on affiche une erreur 404 avec un message d'erreur personnalis√©. Et pour finir, on ins√®re les donn√©es via <code class="language-text">db.Model().Update()</code>.</p>
<p>Dans Postman, s√©lectionnez "PUT" puis l'URL "<a href="http://localhost:3000/api/v1/users/1" target="_blank" rel="nofollow noopener noreferrer">http://localhost:3000/api/v1/users/1</a>", cochez "Body" puis "raw" et copiez les donn√©es √† rentrer <code class="language-text">{ &quot;name&quot;: &quot;John la Frite&quot; }</code> et cliquez sur "Send".</p>
<h3>Supprimer un utilisateur</h3>
<p>Pour supprimer un utilisateur, on veut effectuer la requ√™te SQL ci-dessous.</p>
<div class="gridsome-highlight" data-language="sql"><pre style="counter-reset: linenumber NaN" class="language-sql line-numbers"><code class="language-sql"><span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>On met en place une route de type DELETE avec l'id en param√®tre dans la fonction <code class="language-text">DeleteUser</code>.</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token comment">// Supprimer un utilisateur</span>
<span class="token keyword">func</span> <span class="token function">DeleteUser</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    db <span class="token operator">:=</span> <span class="token function">InitDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// R√©cup√©ration de l'id dans une variable</span>
    id <span class="token operator">:=</span> c<span class="token punctuation">.</span>Params<span class="token punctuation">.</span><span class="token function">ByName</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> user Users
    db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> id<span class="token punctuation">)</span>

    <span class="token keyword">if</span> user<span class="token punctuation">.</span>Id <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token comment">// DELETE FROM users WHERE id = user.Id</span>
        db<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
        <span class="token comment">// Affichage des donn√©es</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"success"</span><span class="token punctuation">:</span> <span class="token string">"User #"</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">" deleted"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Affichage de l'erreur</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"User not found"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Dans un premier temps, on stocke l'id concern√© dans la variable <code class="language-text">id</code> via la fonction <code class="language-text">c.Params.ByName(&quot;id&quot;)</code>. Puis, comme pour la route pr√©c√©dente, on v√©rifie que l'utilisateur existe sinon on affiche une erreur 404 avec un message d'erreur personnalis√©. Si l'utilisateur existe alors on le supprime avec <code class="language-text">db.Delete()</code> et on affiche un message de succ√®s.</p>
<p>Dans Postman, s√©lectionnez "DELETE" puis l'URL "<a href="http://localhost:3000/api/v1/users/1" target="_blank" rel="nofollow noopener noreferrer">http://localhost:3000/api/v1/users/1</a>" et cliquez sur "Send".</p>
<h2>Tests unitaires</h2>
<p><img src="https://i.giphy.com/56LhCE2j6Uy2Y.gif"></p>
<p>Jusqu'ici, on a ex√©cut√© des tests fonctionnels avec Postman. Finalement, il est possible de s'en passer en effectuant une batterie de tests. Concretement, dans un fichier on va effectuer les m√™mes taches que l'on a ex√©cut√© sur Postman mais de mani√®re automatis√©es. Pour ce faire, on va donc travailler dans le fichier d√©di√©, "users_test.go".</p>
<h3>Librairies et variables globales</h3>
<p>On importe un certain nombre de librairies dont l'indispensable "testing" pour n'importe quel test sur Go ainsi que "net/http" et "net/http/httptest" pour des applications orient√©es Web. On d√©clare aussi des variables globales qui vont nous servir dans nos diff√©rentes fonctions.</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">package</span> api_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"io"</span>
    <span class="token string">"net/http"</span>
    <span class="token string">"net/http/httptest"</span>
    <span class="token string">"strings"</span>
    <span class="token string">"testing"</span>

     <span class="token string">"github.com/EtienneR/go_sqlite_api/api"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
    server               <span class="token operator">*</span>httptest<span class="token punctuation">.</span>Server
    reader               io<span class="token punctuation">.</span>Reader
    usersUrl<span class="token punctuation">,</span> usersUrlId <span class="token builtin">string</span>
    userId               <span class="token builtin">int</span>
<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Initialisation</h3>
<p>Lorsqu'on lance une batterie de tests, on se base sur une base de donn√©es vide afin d'√©viter les probl√®mes avec l'auto-increment des id. Pour cela on supprime la table et on l'a cr√©√© avec des utilisateurs. Dans notre cas, ce sera un fichier "data.db" dans le dossier "api". Ensuite, on d√©marre un serveur HTTP de test bas√© sur nos routes. Dans 2 variables, on stocke les URL (la premi√®re sans le param√™tre "id" et la seconde avec).</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Ouverture de la connexion vers la BDD SQLite</span>
    db <span class="token operator">:=</span> api<span class="token punctuation">.</span><span class="token function">InitDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// Fermeture de la connexion vers la BDD SQLite</span>
    <span class="token keyword">defer</span> db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">var</span> user api<span class="token punctuation">.</span>Users

    <span class="token comment">// Suppression de la table</span>
    db<span class="token punctuation">.</span><span class="token function">DropTable</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    <span class="token comment">// Cr√©ation de la table</span>
    db<span class="token punctuation">.</span><span class="token function">CreateTable</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>

    <span class="token comment">// Cr√©ation d'utilisateurs</span>
    db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>api<span class="token punctuation">.</span>Users<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">"Pierre"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>api<span class="token punctuation">.</span>Users<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">"Paul"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>api<span class="token punctuation">.</span>Users<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">"Jacques"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>api<span class="token punctuation">.</span>Users<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">"Marie Th√©r√®se"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// D√©marrage du serveur HTTP</span>
    server <span class="token operator">=</span> httptest<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">Handlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// URL sans param√™tre et avec</span>
    usersUrl <span class="token operator">=</span> server<span class="token punctuation">.</span>URL <span class="token operator">+</span> <span class="token string">"/api/v1/users"</span>
    usersUrlId <span class="token operator">=</span> usersUrl <span class="token operator">+</span> <span class="token string">"/5"</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Fonctions de test</h3>
<p>Comme dans notre test fonctionnel, on va tester chacune des routes de notre API.</p>
<h4>Tester l'ajout d'une ligne</h4>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TestPostUser</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Contenu √† soumettre</span>
    userJson <span class="token operator">:=</span> <span class="token string">`{"name": "Donovan"}`</span>

    <span class="token comment">// Contenu √† soumettre au bon format</span>
    reader <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>userJson<span class="token punctuation">)</span>

    <span class="token comment">// D√©claration de la requ√™te : type, URL, contenu</span>
    request<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span> usersUrl<span class="token punctuation">,</span> reader<span class="token punctuation">)</span>
    <span class="token comment">// Requ√™te de type JSON</span>
    request<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span>

    <span class="token comment">// Ex√©cution de la requ√™te</span>
    response<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span>DefaultClient<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>

    <span class="token comment">// Erreur si route inacessible</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Erreur si code HTTP diff√©rent de 201</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> <span class="token number">201</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Success expected: %d"</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<ol>
<li>On stocke dans une variable le contenu de la ligne que l'on souhaite ajouter ;</li>
<li>On modifie ce contenu pour le rendre lisible au format "NewReader" ;</li>
<li>
<p>On d√©clare la requ√™te avec 3 param√®tres :</p>
<ul>
<li>le type de la route : "POST" ;</li>
<li>l'URL de la route ;</li>
<li>le contenu ;</li>
</ul>
</li>
<li>On sp√©cifie ce contenu au format JSON (afin d'√©viter une erreur HTTP 422) ;</li>
<li>S'il y a une erreur pour contacter la route, alors le test affichera une erreur ;</li>
<li>Si le code HTTP n'est pas 201 alors le test affichera une erreur.</li>
</ol>
<h4>Tester la lecture des lignes</h4>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TestGetUsers</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Contenu √† soumettre vide</span>
    reader <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>

    <span class="token comment">// D√©claration de la req√ª√™te : type, URL, contenu</span>
    request<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">,</span> usersUrl<span class="token punctuation">,</span> reader<span class="token punctuation">)</span>

    <span class="token comment">// Ex√©cution de la requ√™te</span>
    response<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span>DefaultClient<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>

    <span class="token comment">// Erreur si route inacessible</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Erreur si code HTTP diff√©rent de 200</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> <span class="token number">200</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Success expected: %d"</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<ol>
<li>On stocke dans une variable aucun contenu;</li>
<li>
<p>On d√©clare la requ√™te avec 3 param√®tres :</p>
<ul>
<li>le type de la route : "GET" ;</li>
<li>l'URL de la route ;</li>
<li>le contenu (aucun) ;</li>
</ul>
</li>
<li>S'il y a une erreur pour contacter la route, alors le test affichera une erreur ;</li>
<li>Si le code HTTP n'est pas 200 alors le test affichera une erreur.</li>
</ol>
<h4>Tester la lecture d'une ligne</h4>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TestGetUser</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Contenu √† soumettre vide</span>
    reader <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>

    <span class="token comment">// D√©claration de la requ√™te : type, URL, contenu</span>
    request<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">,</span> usersUrlId<span class="token punctuation">,</span> reader<span class="token punctuation">)</span>

    <span class="token comment">// Ex√©cution de la requ√™te</span>
    response<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span>DefaultClient<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>

    <span class="token comment">// Erreur si route inacessible</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Erreur si code HTTP diff√©rent de 200</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> <span class="token number">200</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Success expected: %d"</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<ol>
<li>On stocke dans une variable aucun contenu;</li>
<li>
<p>On d√©clare la requ√™te avec 3 param√®tres :</p>
<ul>
<li>le type de la route : "GET" ;</li>
<li>l'URL de la route avec l'id en param√®tre ;</li>
<li>le contenu (aucun) ;</li>
</ul>
</li>
<li>S'il y a une erreur pour contacter la route, alors le test affichera une erreur ;</li>
<li>Si le code HTTP n'est pas 200 alors le test affichera une erreur.</li>
</ol>
<h4>Tester la modification d'une ligne</h4>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TestEditUser</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Contenu √† soumettre</span>
    userJson <span class="token operator">:=</span> <span class="token string">`{"name": "Mark"}`</span>

    <span class="token comment">// Contenu √† soumettre au bon format</span>
    reader <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>userJson<span class="token punctuation">)</span>

    <span class="token comment">// D√©claration de la requ√™te : type, URL, contenu</span>
    request<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span><span class="token string">"PUT"</span><span class="token punctuation">,</span> usersUrlId<span class="token punctuation">,</span> reader<span class="token punctuation">)</span>
    <span class="token comment">// Requ√™te de type JSON</span>
    request<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span>

    <span class="token comment">// Ex√©cution de la requ√™te</span>
    response<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span>DefaultClient<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>

    <span class="token comment">// Erreur si route inacessible</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Erreur si code HTTP diff√©rent de 200</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> <span class="token number">200</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Success expected: %d"</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<ol>
<li>On stocke dans une variable le contenu de la ligne que l'on souhaite ajouter ;</li>
<li>On modifie ce contenu pour le rendre lisible au format "NewReader" ;</li>
<li>
<p>On d√©clare la requ√™te avec 3 param√®tres :</p>
<ul>
<li>le type de la route : "PUT" ;</li>
<li>l'URL de la route avec l'id en param√®tre ;</li>
<li>le contenu ;</li>
</ul>
</li>
<li>On sp√©cifie ce contenu au format JSON (afin d'√©viter une erreur HTTP 422) ;</li>
<li>S'il y a une erreur pour contacter la route, alors le test affichera une erreur ;</li>
<li>Si le code HTTP n'est pas 200 alors le test affichera une erreur.</li>
</ol>
<h4>Tester la suppression d'une ligne</h4>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TestDeleteUser</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Contenu √† soumettre vide</span>
    reader <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>

    <span class="token comment">// D√©claration de la requ√™te : type, URL, contenu</span>
    request<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span><span class="token string">"DELETE"</span><span class="token punctuation">,</span> usersUrlId<span class="token punctuation">,</span> reader<span class="token punctuation">)</span>

    <span class="token comment">// Ex√©cution de la requ√™te</span>
    response<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span>DefaultClient<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>

    <span class="token comment">// Erreur si route inacessible</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Erreur si code HTTP diff√©rent de 200</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> <span class="token number">200</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Success expected: %d"</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<ol>
<li>On stocke dans une variable aucun contenu;</li>
<li>
<p>On d√©clare la requ√™te avec 3 param√®tres :</p>
<ul>
<li>le type de la route : "DELETE" ;</li>
<li>l'URL de la route avec l'id en param√®tre ;</li>
<li>le contenu (aucun) ;</li>
</ul>
</li>
<li>S'il y a une erreur pour contacter la route, alors le test affichera une erreur ;</li>
<li>Si le code HTTP n'est pas 200 alors le test affichera une erreur.</li>
</ol>
<h3>Lancer la s√©rie des tests</h3>
<p>Dans votre terminal, allez dans le dossier "api" et lancez le test avec la commande <code class="language-text">go test api_test.go</code>. Si tout est ok, vous devriez avoir un message de ce genre : <code class="language-text">ok command-line-arguments 0.210s</code>.`</p>
<p><img src="https://i.giphy.com/ZKf5OzdXdjtRu.gif"></p>
<p>Pour voir tout le processus des tests : <code class="language-text">go test -bench=.</code>.</p>
<p>Dans le dossier "api" vous avez remarqu√© qu'un nouveau fichier a fait son apparition, il s'agit du fichier "data.db" d√©di√© aux tests.</p>
<p>Remarque : si vous utilisez le protocole de versionning Git, n'oubliez pas d'ajouter le chemin du fichier de base de donn√©es de test dans le fichier ".gitignore".</p>
<h2>Options de configurations</h2>
<p>Dans cette partie, nous allons utiliser la notion de "middleware". C'est une fonction qui permet d'√™tre appel√©e depuis une ou plusieurs fonctions.</p>
<h3>CORS (Cross Origin Ressource Sharing)</h3>
<p>Pour √©tablir une communication interdomaine, il faut autoriser la connexion en activant le CORS sinon vous aurez un message explicite dans Firefox.</p>
<div class="gridsome-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Blocage d‚Äôune requ√™te multi-origines <span class="token punctuation">(</span>Cross-Origin Request<span class="token punctuation">)</span> <span class="token builtin class-name">:</span> la politique ¬´ Same Origin ¬ª ne permet pas de consulter la ressource distante situ√©e sur http://localhost:3000/api/v1/users. Raison <span class="token builtin class-name">:</span> l‚Äôen-t√™te CORS ¬´ Access-Control-Allow-Origin ¬ª est manquant.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>Message d'erreur test√© avec le code Javascript ci-dessous.</p>
<div class="gridsome-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'http://localhost:3000/api/v1/users'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'200'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Au niveau local, dans la ou les route(s) concern√©e(s).</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go">c<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Origin"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span>
c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p>L'ast√©risque signifie que l'acc√®s est autoris√© pour n'importe quelle IP. Pour des raisons de s√©curit√©, vous pouvez sp√©cifier une adresse IP ou plusieurs, s√©par√©es par une virgule.</p>
<p>Au niveau global, √† partir d'un middleware, on cr√©√© une fonction nomm√©e <code class="language-text">Cors()</code>.</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">func</span> <span class="token function">Cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> gin<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Origin"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span>
        c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Puis on appel notre fonction <code class="language-text">Cors()</code> dans la fonction <code class="language-text">Handlers()</code> du fichier "api.go".</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token comment">// Activation du CORS</span>
r<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token function">Cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p>Cot√© test unitaire, √ßa donne la v√©rification du header "Access-Control-Allow-Origin".</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">if</span> response<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Origin"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">"*"</span> <span class="token punctuation">{</span>
    t<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"No CORS"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<h3>Activer OPTIONS</h3>
<p>Par d√©faut, lorsque vous allez essayer de faire un requ√™te vers une route de type POST, PUT ou DELETE, un exemple de message ci-dessous apparaitra sur Firefox.</p>
<div class="gridsome-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Blocage d‚Äôune requ√™te multi-origines <span class="token punctuation">(</span>Cross-Origin Request<span class="token punctuation">)</span> <span class="token builtin class-name">:</span> la politique ¬´ Same Origin ¬ª ne permet pas de consulter la ressource distante situ√©e sur http://localhost:3000/api/v1/users. <span class="token punctuation">(</span>Raison <span class="token builtin class-name">:</span> √©chec <span class="token function">du</span> canal de pr√©-v√©rification des requ√™tes CORS.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>Message d'erreur test√© avec le code Javascript ci-dessous.</p>
<div class="gridsome-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'http://localhost:3000/api/v1/users'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json;charset=UTF-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"Jo"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p><img src="https://i.giphy.com/cAEm5rSuuBEGY.gif"></p>
<p>Alors oui ce message est ambig√ºe car on a activ√© le CORS pour toutes les routes. En fait, Firefox ou votre navigateur favori ne trouve pas la route de type "OPTIONS". En regardant de plus pr√®s dans le terminal de Gin, cette route est effectivement d√©clar√©e comme 404.<br>
Pour rem√©dier √† ce probl√®me, on ajoute 2 routes de type "OPTIONS", la premi√®re pour POST et la seconde pour PUT et DELETE.</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go">v1Users<span class="token punctuation">.</span><span class="token function">OPTIONS</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> OptionsUser<span class="token punctuation">)</span>    <span class="token comment">// POST</span>
v1Users<span class="token punctuation">.</span><span class="token function">OPTIONS</span><span class="token punctuation">(</span><span class="token string">":id"</span><span class="token punctuation">,</span> OptionsUser<span class="token punctuation">)</span> <span class="token comment">// PUT, DELETE</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p>Ces derni√®res pointent toutes les deux sur la m√™me fonction, "OptionsUser".</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">func</span> <span class="token function">OptionsUser</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Methods"</span><span class="token punctuation">,</span> <span class="token string">"DELETE, POST, PUT"</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Headers"</span><span class="token punctuation">,</span> <span class="token string">"Content-Type"</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Cot√© tests unitaires, √ßa donne la v√©rification du header "Access-Control-Allow-Methods" ainsi que "Access-Control-Allow-Headers"</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">if</span> response<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Methods"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">"DELETE, POST, PUT"</span> <span class="token punctuation">{</span>
    t<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Methods is wrong :("</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> response<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Headers"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">"Content-Type"</span> <span class="token punctuation">{</span>
    t<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Headers is wrong :("</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>Authentification avec un token</h3>
<p>Le but du token c'est de donner un identifiant g√©n√©r√© al√©atoirement depuis un formulaire d'inscription. Le serveur v√©rifie ensuite si le token existe bien dans la base de donn√©es.<br>
On met en place un middleware nomm√© <code class="language-text">TokenAuthMiddleware()</code>.</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TokenAuthMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span> gin<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// R√©cup√©ration du param√®tre "token" dans une variable</span>
        token <span class="token operator">:=</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">FormValue</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span>

        <span class="token comment">// Token vide</span>
        <span class="token keyword">if</span> token <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
            c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Access denied, API token required"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">Abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// V√©rification de la valeur du token</span>
        <span class="token keyword">if</span> token <span class="token operator">!=</span> <span class="token string">"mon_super_token"</span> <span class="token punctuation">{</span>
            c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Invalid API token"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">Abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>On r√©cup√®re le champ token nomm√© "token" via la fonction <code class="language-text">c.Request.FormValue()</code>. S'il est vide ou si le token n'est pas bon, on renvoit une erreur 403 ou une 401 en personnalisant le message d'erreur.</p>
<p>On peut utiliser le middleware en local.</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go">v1Users<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token function">TokenAuthMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GetUsers<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>Ou en global dans la d√©claration du groupe de routes.</p>
<div class="gridsome-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go">v1Users <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"api/v1/users"</span><span class="token punctuation">,</span> <span class="token function">TokenAuthMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>Pour communiquer avec l'API, on met le token en param√®tre dans l'URL concern√©e <a href="http://localhost:3000/api/v1/users?token=mon_super_token" target="_blank" rel="nofollow noopener noreferrer">http://localhost:3000/api/v1/users?token=mon_super_token</a>. Bien entendu, il existe d'autre solutions comme HTTP authentification (Basic ou Digest), Oauth, Auth, OpenID et d'autres selon vos besoins.</p>
<h2>Conclusion</h2>
<p>Rapide √† mettre en place une fois la structure d√©finie en amont, les routes sont g√©r√©es en aval avec le micro framework accompagn√©es des requ√™tes SQL ad√©quates. Vous pouvez d√©sormais vous concentrer sur vos applications SPA (Single Page Application) et mobiles (Android, IOS, Windows Phone, etc...). Pour aller plus loin, vous pouvez activer HTTPS ce qui activera HTTP 2 pour vous routes (seulement √† partir de Go 1.6).</p>
<h2>Sources</h2>
<ul>
<li>Espace de travail : <a href="https://golang.org/doc/code.html#Workspaces" target="_blank" rel="nofollow noopener noreferrer">https://golang.org/doc/code.html#Workspaces</a></li>
<li>Gin : <a href="https://github.com/gin-gonic/gin" target="_blank" rel="nofollow noopener noreferrer">https://github.com/gin-gonic/gin</a></li>
<li>Pilote SQLite : <a href="https://github.com/mattn/go-sqlite3" target="_blank" rel="nofollow noopener noreferrer">https://github.com/mattn/go-sqlite3</a></li>
<li>Gorm : <a href="http://jinzhu.me/gorm" target="_blank" rel="nofollow noopener noreferrer">http://jinzhu.me/gorm</a></li>
<li>S'en sortir avec SQL sur Go : <a href="http://go-database-sql.org" target="_blank" rel="nofollow noopener noreferrer">http://go-database-sql.org</a></li>
</ul>
</article></div></div></div></main><footer class="text-white mt-4"><ul class="nav nav-pills justify-content-center"><li><a href="https://github.com/etienner" target="_blank" rel="noopener" class="nav-link">Github</a></li><li><a href="https://medium.com/@etiennerouzeaud" target="_blank" rel="noopener" class="nav-link">Medium</a></li><li><a href="https://twitter.com/etiennerouzeaud" target="_blank" rel="noopener" class="nav-link">Twitter</a></li></ul></footer></div>
    <script src="/assets/js/app.cbba8dfd.js" defer></script><script src="/assets/js/page--src--templates--post-vue.7a1fe054.js" defer></script>
  </body>
</html>
