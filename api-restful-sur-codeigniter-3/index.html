<!DOCTYPE html>
<html data-html-server-rendered="true" lang="fr" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22fr%22%7D%7D">
  <head>
    <title>API Restful sur Codeigniter 3 - https://etienner.github.io</title><meta name="gridsome:hash" content="b89929ffb278454bd1f8bb0277abaa50df9b43f7"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.14"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" name="description" content="Apr√®s trois RC (Release Candidate), Codeigniter 3 est sorti ! Parmi les nouveaut√©s qu&#x27;il compte, la possibilit√© de travailler avec les m√©thodes HTTP GET, POST mais √©galement PUT et DELETE. Cela rend plus"><meta data-vue-tag="ssr" property="og:type" content="article"><meta data-vue-tag="ssr" property="og:title" content="API Restful sur Codeigniter 3"><meta data-vue-tag="ssr" property="og:description" content="Apr√®s trois RC (Release Candidate), Codeigniter 3 est sorti ! Parmi les nouveaut√©s qu&#x27;il compte, la possibilit√© de travailler avec les m√©thodes HTTP GET, POST mais √©galement PUT et DELETE. Cela rend plus"><meta data-vue-tag="ssr" property="og:url" content="https://etienner.github.io/api-restful-sur-codeigniter-3/"><meta data-vue-tag="ssr" name="twitter:domain" content="https://etienner.github.io"><meta data-vue-tag="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-tag="ssr" name="twitter:title" content="API Restful sur Codeigniter 3"><meta data-vue-tag="ssr" name="twitter:description" content="Apr√®s trois RC (Release Candidate), Codeigniter 3 est sorti ! Parmi les nouveaut√©s qu&#x27;il compte, la possibilit√© de travailler avec les m√©thodes HTTP GET, POST mais √©galement PUT et DELETE. Cela rend plus"><meta data-vue-tag="ssr" name="twitter:site" content="@etiennerouzeaud"><meta data-vue-tag="ssr" name="twitter:creator" content="@etiennerouzeaud"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/assets/static/favicon.62d22cb.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/assets/static/favicon.1539b60.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/assets/static/favicon.dc0cdc5.9bb7ffafafc09ac851d81afb65b8ef59.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/static/favicon.7b22250.9bb7ffafafc09ac851d81afb65b8ef59.png"><link rel="preload" href="/assets/css/0.styles.a80f6262.css" as="style"><link rel="preload" href="/assets/js/app.50d8a5ce.js" as="script"><link rel="preload" href="/assets/js/page--src-templates-post-vue.56e5bc07.js" as="script"><link rel="prefetch" href="/assets/js/page--node-modules-gridsome-app-pages-404-vue.5bf39404.js"><link rel="prefetch" href="/assets/js/page--src-pages-index-vue.027f19cb.js"><link rel="prefetch" href="/assets/js/page--src-templates-tag-vue.aae09759.js"><link rel="stylesheet" href="/assets/css/0.styles.a80f6262.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div data-server-rendered="true" id="app"><header class="py-2 text-center"><strong><a href="/" title="Accueil" class="active">Etienne ROUZEAUD - D√©veloppeur Web</a></strong></header><main><div class="title py-2 text-center" data-v-4b217994><h1 class="display-5 pt-2" data-v-4b217994>API Restful sur Codeigniter 3</h1><!----></div><div class="container"><div class="row sidebar"><div class="mt-4 col-lg-2"><p><em><span>15 avril 2015</span></em></p><ul class="list-unstyled"><li>
            üè∑Ô∏è <a href="/tag/CodeIgniter/">CodeIgniter</a></li><li>
            üè∑Ô∏è <a href="/tag/API/">API</a></li></ul><p>‚åö 5 mins de lecture</p><p><a href="https://github.com/EtienneR/codeigniter-api" target="_blank" rel="noopener">
            üíæ T√©l√©chargement
          </a></p></div><div class="col-lg-10 mt-4"><!----><article><p>Apr√®s trois RC (Release Candidate), Codeigniter 3 est sorti ! Parmi les nouveaut√©s qu'il compte, la possibilit√© de travailler avec les m√©thodes HTTP GET, POST mais √©galement PUT et DELETE. Cela rend plus facile √† mettre en place une API Restful par rapport √† la version pr√©c√©dente du framework. Quant √† la base de donn√©es, on va rester sur une base SQL.</p>
<h2>Sch√©ma simplifi√©</h2>
<p>On va uniquement travailler sur un contr√¥leur "Product.php" accompagn√© de son mod√®le "Model_product.php". Et on finira par configurer les routes dans le fichier "routes.php".</p>
<div class="gridsome-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">‚îú‚îÄ‚îÄ‚îÄcontrollers
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄapi
‚îÇ       ‚îî‚îÄ‚îÄ‚îÄv1
‚îÇ               Product.php
‚îú‚îÄ‚îÄ‚îÄconfig
‚îÇ       routes.php
‚îú‚îÄ‚îÄ‚îÄmodels
‚îÇ       Model_product.php</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Pr√©paration de la base de donn√©es</h2>
<p>Avant de commencer √† construire l'API, on pr√©pare notre BDD sur MySQL ou MariaDB.</p>
<div class="gridsome-highlight" data-language="sql"><pre style="counter-reset: linenumber NaN" class="language-sql line-numbers"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>codeigniter3_api<span class="token punctuation">`</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_unicode_ci<span class="token punctuation">;</span>
<span class="token keyword">USE</span> <span class="token punctuation">`</span>codeigniter3_api<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>product<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>title<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Puis, on configure l'acc√®s √† la BDD dans le fichier "config/database.php".</p>
<div class="gridsome-highlight" data-language="php"><pre style="counter-reset: linenumber NaN" class="language-php line-numbers"><code class="language-php"><span class="token single-quoted-string string">'hostname'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'localhost'</span><span class="token punctuation">,</span>
<span class="token single-quoted-string string">'username'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'root'</span><span class="token punctuation">,</span>
<span class="token single-quoted-string string">'password'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">''</span><span class="token punctuation">,</span>
<span class="token single-quoted-string string">'database'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'codeigniter_api'</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Cr√©ation du mod√®le</h2>
<p>Dans notre mod√®le "Model_product.php", on va d√©clarer les 5 fonctions comportant les requ√™tes SQL CRUD ayant pour mission :</p>
<ol>
<li>Obtenir tous les produits ;</li>
<li>Obtenir un produit en particulier ;</li>
<li>Cr√©er un nouveau produit ;</li>
<li>Modifier un produit ;</li>
<li>Supprimer un produit.</li>
</ol>
<div class="gridsome-highlight" data-language="php"><pre style="counter-reset: linenumber NaN" class="language-php line-numbers"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">defined</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'BASEPATH'</span><span class="token punctuation">)</span> <span class="token keyword">OR</span> <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'No direct script access allowed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Model_product</span> <span class="token keyword">extends</span> <span class="token class-name">CI_Model</span> <span class="token punctuation">{</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">parent</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">table</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"product"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">get_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">table</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">get_one</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">select</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"id, title"</span><span class="token punctuation">)</span>
                 <span class="token operator">-</span><span class="token operator">></span><span class="token function">from</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">table</span><span class="token punctuation">)</span>
                 <span class="token operator">-</span><span class="token operator">></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"id"</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span>
                 <span class="token operator">-</span><span class="token operator">></span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token variable">$title</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
            <span class="token double-quoted-string string">"title"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$title</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">table</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">,</span> <span class="token variable">$title</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
            <span class="token double-quoted-string string">"title"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$title</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"id"</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span>
                 <span class="token operator">-</span><span class="token operator">></span><span class="token function">update</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">table</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">where_in</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"id"</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span>
                 <span class="token operator">-</span><span class="token operator">></span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">table</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token comment">/* End of file Model_product.php */</span>
<span class="token comment">/* Location: ./application/models/Model_product.php */</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Cr√©ation du contr√¥leur</h2>
<p>Dans notre contr√¥leur, on va retrouver les 5 fonctions que l'on a cr√©√© pr√©c√©demment dans notre mod√®le et que l'on ajoutera dans notre fichier routes. Ces fonctions retourneront des valeurs aux formats Json et dans le bon code HTTP.</p>
<div class="gridsome-highlight" data-language="php"><pre style="counter-reset: linenumber NaN" class="language-php line-numbers"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">defined</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'BASEPATH'</span><span class="token punctuation">)</span> <span class="token keyword">OR</span> <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'No direct script access allowed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token keyword">extends</span> <span class="token class-name">CI_Controller</span> <span class="token punctuation">{</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">parent</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">load</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">load</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">model</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"Model_product"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">Model_product</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$data</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">num_rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$data</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$row</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"id"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$row</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">id</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"title"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$row</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">title</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"HTTP/1.0 204 No Content"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"204: no products in the database"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">Model_product</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get_one</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$data</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">num_rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$data</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$row</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"id"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$row</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">id</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"title"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$row</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">title</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"HTTP/1.0 404 Not Found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"404 : Product #<span class="token interpolation"><span class="token variable">$id</span></span> not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$title</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">input</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'title'</span><span class="token punctuation">,</span> <span class="token boolean constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$title</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">Model_product</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token variable">$title</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Product created'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"HTTP/1.0 400 Bad Request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"400: Empty value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$title</span> <span class="token operator">=</span> <span class="token function">utf8_encode</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">input</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">input_stream</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'title'</span><span class="token punctuation">,</span> <span class="token boolean constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">Model_product</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get_one</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">num_rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$title</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">Model_product</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">put</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">,</span> <span class="token variable">$title</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"200: Product #<span class="token interpolation"><span class="token variable">$id</span></span> updated"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"HTTP/1.0 400 Bad Request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"400: Empty value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"HTTP/1.0 404 Not Found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"404: Product #<span class="token interpolation"><span class="token variable">$id</span></span> not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">Model_product</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get_one</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">num_rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">Model_product</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"200: Product #<span class="token interpolation"><span class="token variable">$id</span></span> deleted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"HTTP/1.0 404 Not Found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"404: Product <span class="token interpolation"><span class="token variable">$id</span></span> not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* End of file Product.php */</span>
<span class="token comment">/* Location: ./application/controllers/Product.php */</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Dans le constructeur, on charge la connexion √† la BDD et le mod√®le.
Pour les 2 derni√®res fonctions (modification et suppression), on v√©rifie que le produit existe.<br>
Dans la fonction <code class="language-text">update</code>, on r√©cup√®re les informations rentr√©es par l'utilisateur via la fonction <code class="language-text">$this-&gt;input-&gt;input_stream</code>.</p>
<p>Important : on active la protection contre les injections XSS avec le param√™tre "TRUE" pour les fonctions <code class="language-text">input-&gt;post</code> et <code class="language-text">input-&gt;input_stream</code>.</p>
<p>Remarque : on convertit la valeur de l'id du ou des produit(s) en entier car par d√©faut, Codeigniter renvoit au format "string" (chaine de caract√®res) les donn√©es suppos√©es √™tre des "int" (entiers).</p>
<h2>Pr√©paration des routes</h2>
<p>Pour finir, √©ditez le fichier "application/config/routes.php" et ajoutez les routes ci-dessous correspondant aux fonctions pr√©sentes dans notre contr√¥leur.</p>
<div class="gridsome-highlight" data-language="php"><pre style="counter-reset: linenumber NaN" class="language-php line-numbers"><code class="language-php"><span class="token variable">$route</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"api/v1/product"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"get"</span><span class="token punctuation">]</span>           <span class="token operator">=</span> <span class="token double-quoted-string string">"api/v1/product"</span><span class="token punctuation">;</span>
<span class="token variable">$route</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"api/v1/product/(:num)"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"get"</span><span class="token punctuation">]</span>    <span class="token operator">=</span> <span class="token double-quoted-string string">"api/v1/product/view/<span class="token interpolation"><span class="token variable">$1</span></span>"</span><span class="token punctuation">;</span>
<span class="token variable">$route</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"api/v1/product"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"post"</span><span class="token punctuation">]</span>          <span class="token operator">=</span> <span class="token double-quoted-string string">"api/v1/product/create"</span><span class="token punctuation">;</span>
<span class="token variable">$route</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"api/v1/product/(:num)"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"put"</span><span class="token punctuation">]</span>    <span class="token operator">=</span> <span class="token double-quoted-string string">"api/v1/product/update/<span class="token interpolation"><span class="token variable">$1</span></span>"</span><span class="token punctuation">;</span>
<span class="token variable">$route</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"api/v1/product/(:num)"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"delete"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"api/v1/product/delete/<span class="token interpolation"><span class="token variable">$1</span></span>"</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>On suffixe dans chaque route, la m√©thode HTTP concern√©e (GET, POST, PUT ou DELETE).</p>
<h2>Testons avec l'ami CURL</h2>
<h3>GET</h3>
<p><code class="language-text">curl http://localhost/codeigniter-api/api/v1/product</code><br>
<code class="language-text">curl http://localhost/codeigniter-api/api/v1/product/1</code></p>
<p>Remarque : vous pouvez aussi tester les requ√™tes HTTP de type GET sur votre navigateur Web...</p>
<h3>POST</h3>
<p><code class="language-text">curl -d title=&quot;product title&quot; http://localhost/codeigniter-api/api/v1/product</code><br>
<code class="language-text">curl -d title=&quot;&lt;script src=&#39;alert&#39;&gt;alert&lt;/script&gt;&quot; http://localhost/codeigniter-api/api/v1/product</code></p>
<h3>PUT</h3>
<p><code class="language-text">curl -X PUT -d title=&quot;edit product title&quot; http://localhost/codeigniter-api/api/v1/product/1</code><br>
<code class="language-text">curl -X PUT -d title=&quot;&lt;script src=&#39;alert&#39;&gt;alert&lt;/script&gt;&quot; http://localhost/codeigniter-api/api/v1/product/1</code></p>
<h3>DELETE</h3>
<p><code class="language-text">curl -X DELETE http://localhost/codeigniter-api/api/v1/product/1</code></p>
<h2>CORS</h2>
<p>Par d√©faut, si vous souhaitez travailler sur une application tournant sur un autre port autre que celui de votre serveur Apache, Nginx, etc... vous aurez un message d'erreur car le CORS restreint l'acc√®s √† votre API.<br>
Dans le constructeur du contr√¥leur, ajoutez la ligne suivante.</p>
<div class="gridsome-highlight" data-language="php"><pre style="counter-reset: linenumber NaN" class="language-php line-numbers"><code class="language-php"><span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"Access-Control-Allow-Origin: *"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<h2>Conclusion</h2>
<p>Codeigniter 3 permet de cr√©er rapidement une API Restful gr√¢ce aux nouvelles fonctionnalit√©es telles que <code class="language-text">$this-&gt;input-&gt;valeur</code> et la possibilit√© de d√©clarer les m√©thodes HTTP dans les routes. Vous pouvez √©galement rajouter un syst√®me de v√©rification de token pour ajouter de la s√©curit√© √† votre API. Dans ce cas, il faudra rajouter une condition sur les fonctions concern√©es dans le contr√¥leur.</p>
<h2>Sources</h2>
<ul>
<li>php://input stream : <a href="http://www.codeigniter.com/userguide3/libraries/input.html#using-the-php-input-stream" target="_blank" rel="nofollow noopener noreferrer">http://www.codeigniter.com/userguide3/libraries/input.html#using-the-php-input-stream</a> ;</li>
<li>Les routes avec leur m√©thode HTTP : <a href="http://www.codeigniter.com/userguide3/general/routing.html#using-http-verbs-in-routes" target="_blank" rel="nofollow noopener noreferrer">http://www.codeigniter.com/userguide3/general/routing.html#using-http-verbs-in-routes</a></li>
</ul>
</article></div></div></div></main><footer class="text-white mt-4"><ul class="nav nav-pills justify-content-center"><li><a href="https://github.com/etienner" target="_blank" rel="noopener" class="nav-link">Github</a></li><li><a href="https://medium.com/@etiennerouzeaud" target="_blank" rel="noopener" class="nav-link">Medium</a></li><li><a href="https://twitter.com/etiennerouzeaud" target="_blank" rel="noopener" class="nav-link">Twitter</a></li></ul></footer></div>
    <script src="/assets/js/app.50d8a5ce.js" defer></script><script src="/assets/js/page--src-templates-post-vue.56e5bc07.js" defer></script>
  </body>
</html>
