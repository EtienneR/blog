<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="lang">
  <head>
    <title>API Restful sur Codeigniter 3 - https://etienner.github.io</title><meta name="gridsome:hash" content="a6a83eeab333c7bbcf47fff9751f8c5dda4260fc"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.2"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" name="description" content="Après trois RC (Release Candidate), Codeigniter 3 est sorti ! Parmi les nouveautés qu&#x27;il compte, la possibilité de travailler avec les méthodes HTTP GET, POST mais également PUT et DELETE. Cela rend plus"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.9bb7ffa.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.9bb7ffa.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.9bb7ffa.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.9bb7ffa.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/assets/static/favicon.62d22cb.9bb7ffa.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/assets/static/favicon.1539b60.9bb7ffa.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/assets/static/favicon.dc0cdc5.9bb7ffa.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/static/favicon.7b22250.9bb7ffa.png"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript><link rel="preload" href="/assets/css/0.styles.2ee79837.css" as="style"><link rel="preload" href="/assets/js/app.b659722c.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--post-vue.6a9fe53b.js" as="script"><link rel="prefetch" href="/assets/js/page--node-modules--gridsome--app--pages--404-vue.14b4f713.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.2907f5d3.js"><link rel="stylesheet" href="/assets/css/0.styles.2ee79837.css">
  </head>
  <body >
    <div data-server-rendered="true" id="app"><header><div class="container text-center"><strong><a href="/" title="Accueil" class="active">Etienne ROUZEAUD - Développeur Web</a></strong></div></header><div class="text-center title"><h1 class="display-5">API Restful sur Codeigniter 3</h1><p><em>Posté le <span>15 avril 2015</span></em></p></div><div class="container"><article class="mt-4"><p>Après trois RC (Release Candidate), Codeigniter 3 est sorti ! Parmi les nouveautés qu'il compte, la possibilité de travailler avec les méthodes HTTP GET, POST mais également PUT et DELETE. Cela rend plus facile à mettre en place une API Restful par rapport à la version précédente du framework. Quant à la base de données, on va rester sur une base SQL.</p>
<h2 id="schéma-simplifié"><a href="#sch%C3%A9ma-simplifi%C3%A9" aria-hidden="true"><span class="icon icon-link"></span></a>Schéma simplifié</h2>
<p>On va uniquement travailler sur un contrôleur "Product.php" accompagné de son modèle "Model_product.php". Et on finira par configurer les routes dans le fichier "routes.php".</p>
<pre class="language-text"><code class="language-text">├───controllers
│   │
│   └───api
│       └───v1
│               Product.php
├───config
│       routes.php
├───models
│       Model_product.php</code></pre>
<h2 id="préparation-de-la-base-de-données"><a href="#pr%C3%A9paration-de-la-base-de-donn%C3%A9es" aria-hidden="true"><span class="icon icon-link"></span></a>Préparation de la base de données</h2>
<p>Avant de commencer à construire l'API, on prépare notre BDD sur MySQL ou MariaDB.</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>codeigniter3_api<span class="token punctuation">`</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_unicode_ci<span class="token punctuation">;</span>
<span class="token keyword">USE</span> <span class="token punctuation">`</span>codeigniter3_api<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>product<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>title<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span> 
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Puis, on configure l'accès à la BDD dans le fichier "config/database.php".</p>
<pre class="language-php"><code class="language-php"><span class="token single-quoted-string string">'hostname'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'localhost'</span><span class="token punctuation">,</span>
<span class="token single-quoted-string string">'username'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'root'</span><span class="token punctuation">,</span>
<span class="token single-quoted-string string">'password'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">''</span><span class="token punctuation">,</span>
<span class="token single-quoted-string string">'database'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'codeigniter_api'</span><span class="token punctuation">,</span></code></pre>
<h2 id="création-du-modèle"><a href="#cr%C3%A9ation-du-mod%C3%A8le" aria-hidden="true"><span class="icon icon-link"></span></a>Création du modèle</h2>
<p>Dans notre modèle "Model_product.php", on va déclarer les 5 fonctions comportant les requêtes SQL CRUD ayant pour mission :</p>
<ol>
<li>Obtenir tous les produits ;</li>
<li>Obtenir un produit en particulier ;</li>
<li>Créer un nouveau produit ;</li>
<li>Modifier un produit ;</li>
<li>Supprimer un produit.</li>
</ol>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">defined</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'BASEPATH'</span><span class="token punctuation">)</span> <span class="token keyword">OR</span> <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'No direct script access allowed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Model_product</span> <span class="token keyword">extends</span> <span class="token class-name">CI_Model</span> <span class="token punctuation">{</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token scope"><span class="token keyword">parent</span><span class="token punctuation">::</span></span><span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">table</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"product"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">get_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">table</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">get_one</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">select</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"id, title"</span><span class="token punctuation">)</span>
                 <span class="token operator">-</span><span class="token operator">></span><span class="token function">from</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">table</span><span class="token punctuation">)</span>
                 <span class="token operator">-</span><span class="token operator">></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"id"</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span>
                 <span class="token operator">-</span><span class="token operator">></span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token variable">$title</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
            <span class="token double-quoted-string string">"title"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$title</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">table</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">,</span> <span class="token variable">$title</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
            <span class="token double-quoted-string string">"title"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$title</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"id"</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span>
                 <span class="token operator">-</span><span class="token operator">></span><span class="token function">update</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">table</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">where_in</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"id"</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span>
                 <span class="token operator">-</span><span class="token operator">></span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">table</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token comment">/* End of file Model_product.php */</span>
<span class="token comment">/* Location: ./application/models/Model_product.php */</span></span></code></pre>
<h2 id="création-du-contrôleur"><a href="#cr%C3%A9ation-du-contr%C3%B4leur" aria-hidden="true"><span class="icon icon-link"></span></a>Création du contrôleur</h2>
<p>Dans notre contrôleur, on va retrouver les 5 fonctions que l'on a créé précédemment dans notre modèle et que l'on ajoutera dans notre fichier routes. Ces fonctions retourneront des valeurs aux formats Json et dans le bon code HTTP.</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">defined</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'BASEPATH'</span><span class="token punctuation">)</span> <span class="token keyword">OR</span> <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'No direct script access allowed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token keyword">extends</span> <span class="token class-name">CI_Controller</span> <span class="token punctuation">{</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token scope"><span class="token keyword">parent</span><span class="token punctuation">::</span></span><span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">load</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">load</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">model</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"Model_product"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">Model_product</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$data</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">num_rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$data</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$row</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"id"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$row</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">id</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"title"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$row</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">title</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"HTTP/1.0 204 No Content"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"204: no products in the database"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">Model_product</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get_one</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$data</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">num_rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$data</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$row</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"id"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$row</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">id</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"title"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$row</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">title</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"HTTP/1.0 404 Not Found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"404 : Product #<span class="token interpolation"><span class="token variable">$id</span></span> not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$title</span> <span class="token operator">=</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">input</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'title'</span><span class="token punctuation">,</span> <span class="token boolean constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$title</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">Model_product</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token variable">$title</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Product created'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"HTTP/1.0 400 Bad Request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"400: Empty value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$title</span> <span class="token operator">=</span> <span class="token function">utf8_encode</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">input</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">input_stream</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'title'</span><span class="token punctuation">,</span> <span class="token boolean constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">Model_product</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get_one</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">num_rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$title</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">Model_product</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">put</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">,</span> <span class="token variable">$title</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"200: Product #<span class="token interpolation"><span class="token variable">$id</span></span> updated"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"HTTP/1.0 400 Bad Request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"400: Empty value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"HTTP/1.0 404 Not Found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"404: Product #<span class="token interpolation"><span class="token variable">$id</span></span> not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">Model_product</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get_one</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">num_rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">Model_product</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"200: Product #<span class="token interpolation"><span class="token variable">$id</span></span> deleted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
            <span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"HTTP/1.0 404 Not Found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"404: Product <span class="token interpolation"><span class="token variable">$id</span></span> not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* End of file Product.php */</span>
<span class="token comment">/* Location: ./application/controllers/Product.php */</span></span></code></pre>
<p>Dans le constructeur, on charge la connexion à la BDD et le modèle.
Pour les 2 dernières fonctions (modification et suppression), on vérifie que le produit existe.<br>
Dans la fonction <code class="language-text">update</code>, on récupère les informations rentrées par l'utilisateur via la fonction <code class="language-text">$this-&gt;input-&gt;input_stream</code>.</p>
<p>Important : on active la protection contre les injections XSS avec le paramêtre "TRUE" pour les fonctions <code class="language-text">input-&gt;post</code> et <code class="language-text">input-&gt;input_stream</code>. </p>
<p>Remarque : on convertit la valeur de l'id du ou des produit(s) en entier car par défaut, Codeigniter renvoit au format "string" (chaine de caractères) les données supposées être des "int" (entiers).</p>
<h2 id="préparation-des-routes"><a href="#pr%C3%A9paration-des-routes" aria-hidden="true"><span class="icon icon-link"></span></a>Préparation des routes</h2>
<p>Pour finir, éditez le fichier "application/config/routes.php" et ajoutez les routes ci-dessous correspondant aux fonctions présentes dans notre contrôleur.</p>
<pre class="language-php"><code class="language-php"><span class="token variable">$route</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"api/v1/product"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"get"</span><span class="token punctuation">]</span>           <span class="token operator">=</span> <span class="token double-quoted-string string">"api/v1/product"</span><span class="token punctuation">;</span>
<span class="token variable">$route</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"api/v1/product/(:num)"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"get"</span><span class="token punctuation">]</span>    <span class="token operator">=</span> <span class="token double-quoted-string string">"api/v1/product/view/<span class="token interpolation"><span class="token variable">$1</span></span>"</span><span class="token punctuation">;</span>
<span class="token variable">$route</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"api/v1/product"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"post"</span><span class="token punctuation">]</span>          <span class="token operator">=</span> <span class="token double-quoted-string string">"api/v1/product/create"</span><span class="token punctuation">;</span>
<span class="token variable">$route</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"api/v1/product/(:num)"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"put"</span><span class="token punctuation">]</span>    <span class="token operator">=</span> <span class="token double-quoted-string string">"api/v1/product/update/<span class="token interpolation"><span class="token variable">$1</span></span>"</span><span class="token punctuation">;</span>
<span class="token variable">$route</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"api/v1/product/(:num)"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"delete"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"api/v1/product/delete/<span class="token interpolation"><span class="token variable">$1</span></span>"</span><span class="token punctuation">;</span></code></pre>
<p>On suffixe dans chaque route, la méthode HTTP concernée (GET, POST, PUT ou DELETE).</p>
<h2 id="testons-avec-lami-curl"><a href="#testons-avec-lami-curl" aria-hidden="true"><span class="icon icon-link"></span></a>Testons avec l'ami CURL</h2>
<h3 id="get"><a href="#get" aria-hidden="true"><span class="icon icon-link"></span></a>GET</h3>
<p><code class="language-text">curl http://localhost/codeigniter-api/api/v1/product</code><br>
<code class="language-text">curl http://localhost/codeigniter-api/api/v1/product/1</code></p>
<p>Remarque : vous pouvez aussi tester les requêtes HTTP de type GET sur votre navigateur Web...</p>
<h3 id="post"><a href="#post" aria-hidden="true"><span class="icon icon-link"></span></a>POST</h3>
<p><code class="language-text">curl -d title=&quot;product title&quot; http://localhost/codeigniter-api/api/v1/product</code><br>
<code class="language-text">curl -d title=&quot;&lt;script src=&#39;alert&#39;&gt;alert&lt;/script&gt;&quot; http://localhost/codeigniter-api/api/v1/product</code></p>
<h3 id="put"><a href="#put" aria-hidden="true"><span class="icon icon-link"></span></a>PUT</h3>
<p><code class="language-text">curl -X PUT -d title=&quot;edit product title&quot; http://localhost/codeigniter-api/api/v1/product/1</code><br>
<code class="language-text">curl -X PUT -d title=&quot;&lt;script src=&#39;alert&#39;&gt;alert&lt;/script&gt;&quot; http://localhost/codeigniter-api/api/v1/product/1</code></p>
<h3 id="delete"><a href="#delete" aria-hidden="true"><span class="icon icon-link"></span></a>DELETE</h3>
<p><code class="language-text">curl -X DELETE http://localhost/codeigniter-api/api/v1/product/1</code></p>
<h2 id="cors"><a href="#cors" aria-hidden="true"><span class="icon icon-link"></span></a>CORS</h2>
<p>Par défaut, si vous souhaitez travailler sur une application tournant sur un autre port autre que celui de votre serveur Apache, Nginx, etc... vous aurez un message d'erreur car le CORS restreint l'accès à votre API.<br>
Dans le constructeur du contrôleur, ajoutez la ligne suivante.</p>
<pre class="language-php"><code class="language-php"><span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"Access-Control-Allow-Origin: *"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2 id="conclusion"><a href="#conclusion" aria-hidden="true"><span class="icon icon-link"></span></a>Conclusion</h2>
<p>Codeigniter 3 permet de créer rapidement une API Restful grâce aux nouvelles fonctionnalitées telles que <code class="language-text">$this-&gt;input-&gt;valeur</code> et la possibilité de déclarer les méthodes HTTP dans les routes. Vous pouvez également rajouter un système de vérification de token pour ajouter de la sécurité à votre API. Dans ce cas, il faudra rajouter une condition sur les fonctions concernées dans le contrôleur.</p>
<h2 id="sources"><a href="#sources" aria-hidden="true"><span class="icon icon-link"></span></a>Sources</h2>
<ul>
<li>php://input stream : <a href="http://www.codeigniter.com/userguide3/libraries/input.html#using-the-php-input-stream" target="_blank" rel="nofollow noopener noreferrer">http://www.codeigniter.com/userguide3/libraries/input.html#using-the-php-input-stream</a></li>
<li>Les routes avec leur méthode HTTP : <a href="http://www.codeigniter.com/userguide3/general/routing.html#using-http-verbs-in-routes" target="_blank" rel="nofollow noopener noreferrer">http://www.codeigniter.com/userguide3/general/routing.html#using-http-verbs-in-routes</a></li>
</ul>
</article></div><footer class="text-white mt-4"><ul class="nav nav-pills justify-content-center"><li><a href="https://github.com/etienner" target="_blank" class="nav-link">Github</a></li><li><a href="https://medium.com/@etiennerouzeaud" target="_blank" class="nav-link">Medium</a></li><li><a href="https://twitter.com/etiennerouzeaud" target="_blank" class="nav-link">Twitter</a></li></ul></footer></div>
    <script src="/assets/js/app.b659722c.js" defer></script><script src="/assets/js/page--src--templates--post-vue.6a9fe53b.js" defer></script>
  </body>
</html>
