<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="lang">
  <head>
    <title>Connexion / déconnexion avec Gin - https://etienner.github.io</title><meta name="gridsome:hash" content="41452752fefa88bad284d1f2761f45ec58a3a74c"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.2"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" name="description" content="Lorsqu&#x27;un utilisateur s&#x27;authentifie sur une page de connexion, cela créé un cookie de session. De ce fait, si l&#x27;utilisateur tente de se rendre sur une page protégée sans s&#x27;être authentifié, ne possédant"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.9bb7ffa.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.9bb7ffa.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.9bb7ffa.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.9bb7ffa.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/assets/static/favicon.62d22cb.9bb7ffa.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/assets/static/favicon.1539b60.9bb7ffa.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/assets/static/favicon.dc0cdc5.9bb7ffa.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/static/favicon.7b22250.9bb7ffa.png"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript><link rel="preload" href="/assets/css/0.styles.2ee79837.css" as="style"><link rel="preload" href="/assets/js/app.06de8649.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--post-vue.6a9fe53b.js" as="script"><link rel="prefetch" href="/assets/js/page--node-modules--gridsome--app--pages--404-vue.14b4f713.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.d116fa6d.js"><link rel="stylesheet" href="/assets/css/0.styles.2ee79837.css">
  </head>
  <body >
    <div data-server-rendered="true" id="app"><header><div class="container text-center"><strong><a href="/" title="Accueil" class="active">Etienne ROUZEAUD - Développeur Web</a></strong></div></header><div class="text-center title"><h1 class="display-5">Connexion / déconnexion avec Gin</h1><p><em>Posté le <span>14 août 2017</span></em></p></div><div class="container"><article class="mt-4"><p>Lorsqu'un utilisateur s'authentifie sur une page de connexion, cela créé un cookie de session. De ce fait, si l'utilisateur tente de se rendre sur une page protégée sans s'être authentifié, ne possédant pas le cookie de session sur son navigateur Web, il ne pourra pas y accéder. Quant à la déconnexion, cela aura pour effet de supprimer le cookie de session.</p>
<p>Dans un premier temps on va mettre en place un système simpliste, puis on introduira la notion de hachage de mot de passe avec Bcrypt, l'apport d'un token CSRF et on finira en créant une liste d'utilisateurs sur une base de donnée de type SQL via SQLite.</p>
<p><img class="g-image g-image--lazy g-image--loading" src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 816 555' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-31'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='40'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-31)' width='816' height='555' xlink:href='data:image/gif%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAAsCAIAAABaPSmoAAAACXBIWXMAAAPoAAAD6AG1e1JrAAAE4ElEQVRo3u1W609bZRzuPyH4YSZcS9HSK20H3RYhXFoEYkLmEpMlxsSQfVl0F0QmytjUT34wajT7YFCXaZYsEJY5E78ZBsTQG6WUQUtbeqEXenpK6b2n%2bJxzKLYbm1PIYMl58ut73vc5v/c9v%2be9/N7yJv6YCm8mAv71rSjpX/e53Wu2ZZvH7V73edb9vmwuS1G5o2w83Yp/M7cdTWbTWcq/senybTjdIV%2bIJGIpIpbMbx918C4PX/9g8NMPP/ns8sfXUA6OfDE48vmlK6OXrly7OHT1wkcjKFlDHT4ozw8M05Whq%2biICkqWuTg0uuPJWKHj6G6FJTEyDP4Dw9f3bzyBoP54U3NtLb%2buTiCRSBsaRCKxtFl9SqlUNalPKhSqBpFYJJbAGhuV1dXVMpm8paW1srJSKpM1NasrKirkcsXrLa1VVVX82lpBHYbBj18vENDPOn4dHySfrTMUH4PU1NS8cuxYedlLL5eX/S8rL1gZT6FS9Z0%2bI5XKZXKF%2bsTJ401N6lMtZ9/p7%2bs7ffbd/u6eN5UqVbP6BES2tnVARnun5r3%2bc4L6V9/o7j3//gUIf%2bvM2wODQ68JGzo6tb29ve1tbZ2aru6enq6uLo1G29Gp0Wq1Gm0XKiDb2tsVSiW%2bIhQKobl63%2bBhxjGpmHuYVCqjK1KpCMsgFjOlhH1Fm1gipiHBKuEBb3ljo5ghGXcJC8ZHLBLvoNDrH7Bu%2bK6wCA0FCEvxCMk2RQWA4Y2PjwcCATsDh8PhWluDud1uFwMkJRAA%2b3Cs0oDbahEcjzH/Cni7nE5XEegRHA7nLsl8Dk0HDSficXvoUBgvBxsDmjMzM7zZ2Vmc5VwuhzKdTpNkJBbbjEQiCQYEQYAho1GCCG/Gtg4qdeTz%2bWQqhfGTyWSCthQYJoAMmul0KhaLbcUTWSYqeEcIIhgIkiSZL02LXq%2bXNzX1gA0dGkiS0Ot1ZrNpTj9nMulsNvuCxWLU64xo6P5asC6hezaLYfcFiqKSiTi%2b7fF4MNX0bHs8CACBhsNhTLzP51u12bD8YSICYYn41uKixWw0WBatiVQ6T1GZTAZh4BXWgTc9Pc2uAJAvEpjLZnFRPD5zB4UnjfwU3u3xGgxm1NlZAAO1JQIAaMswyDJTnSlCtgDWc/9L8ezAtxEx9vOKzY5IoIFiJJUKoHLYgvlS9dtPaFL5wwFk7FZKBADYZffu/45dRZLRUCiIc0/iLBMECp/PGwiG4vF4hAjjQDOnx71BELQSijosJY8KmH3w5w8/3vz11s/ffPvdTzdvTU5O3P/t3tjY2I0b30/evfvL7Tsov/7qy9t3JrASSK8G4zy7dEdCAJjwRshuXw34/ci%2bXu96lPlzGgqFVu12zHowGFxeWUFe9nh99Hlac/qDoSO0AmxWKt7re%2baEXT5XCHz3nDHn6jBXII%2bNrtfp7Da70WgwGHS47JaXlnA7Ly5Y5s1mnV5vtS49tC6aTOblJav14TJ7Kerm5lxrTpPJNG%2b2IFccaKb9LwLYtIhjmsQNmUolmUcykcD9AnKL5nFB4orceYUnfiBwm6JjkvZNPs/t9LQt9Cx/BPZsHuYWYpMJRe9jigVbKbSo4gTMvsgzTIGnnvNp3lvACwROACeAE8AJ4ARwAjgBnABOACeAE8AJ4ARwAjgBnIDDFzDzQgv4G1KHFUAL5WejAAAAAElFTkSuQmCC' /%3e%3c/svg%3e" width="816" data-srcset="/assets/static/gin_session.82a2fbd.816a885.gif 480w, /assets/static/gin_session.6dd9030.816a885.gif 816w" data-sizes="(max-width: 816px) 100vw, 816px" data-src="/assets/static/gin_session.6dd9030.816a885.gif"><noscript><img class="g-image g-image--lazy g-image--loaded" src="/assets/static/gin_session.6dd9030.816a885.gif" width="816"></noscript></p>
<h2 id="préparation"><a href="#pr%C3%A9paration" aria-hidden="true"><span class="icon icon-link"></span></a>Préparation</h2>
<h3 id="packages-externes"><a href="#packages-externes" aria-hidden="true"><span class="icon icon-link"></span></a>Packages externes</h3>
<p><code class="language-text">go get github.com/gin-gonic/gin &amp;&amp; go get github.com/gorilla/securecookie &amp;&amp; go get github.com/gorilla/csrf &amp;&amp; github.com/mattn/go-sqlite3 &amp;&amp; github.com/jinzhu/gorm</code></p>
<ul>
<li><strong>Gin</strong> : le micro framework ;</li>
<li><strong>securecookie</strong> : cookie de session ;</li>
<li><strong>csrf</strong> : gestion du token du même nom ;</li>
<li><strong>go-sqlite3</strong> : le driver pour SQlite ;</li>
<li><strong>gorm</strong> : l'ORM pour les requêtes SQL.</li>
</ul>
<h3 id="vue-densemble-des-fichiers"><a href="#vue-densemble-des-fichiers" aria-hidden="true"><span class="icon icon-link"></span></a>Vue d'ensemble des fichiers</h3>
<p>Ci-dessous l'architecture de notre application de connexion / déconnexion.</p>
<pre class="language-bash"><code class="language-bash">│   main.go
│
├───controllers
│       back.go
│       front.go
│       session.go
│
├───db
│       db.go
<span class="token operator">|</span>
├───helpers
│       cookies.go
│       password.go
│
└───views
        view_admin.html
        view_footer.html
        view_form.html
        view_header.html
        view_index.html</code></pre>
<h3 id="structure-de-données"><a href="#structure-de-donn%C3%A9es" aria-hidden="true"><span class="icon icon-link"></span></a>Structure de données</h3>
<p>Dans le dossier "db/db.go", on crée la structure de données "Users".</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> db

<span class="token comment">// La structure de données</span>
<span class="token keyword">type</span> Users <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Id             <span class="token builtin">int</span>
    Name<span class="token punctuation">,</span> Password <span class="token builtin">string</span>
<span class="token punctuation">}</span></code></pre>
<p>Un utilisateur possède un nom ("Name") et un mot de passe ("Password").</p>
<h3 id="template"><a href="#template" aria-hidden="true"><span class="icon icon-link"></span></a>Template</h3>
<p>Il serait dommage de se priver des templates avec Go.</p>
<h4 id="le-header"><a href="#le-header" aria-hidden="true"><span class="icon icon-link"></span></a>Le header</h4>
<p>On définit un template "header" contenant la majorité de notre code HTML dans le fichier "views/view_header.html".</p>
<pre class="language-html"><code class="language-html">{{ define "header" }}

<span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Bienvenue sur mon site<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nav</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>navbar navbar-default<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>container-fluid<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>navbar-header<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>navbar-toggle collapsed<span class="token punctuation">"</span></span> <span class="token attr-name">data-toggle</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>collapse<span class="token punctuation">"</span></span> <span class="token attr-name">data-target</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#bs-example-navbar-collapse-1<span class="token punctuation">"</span></span> <span class="token attr-name">aria-expanded</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sr-only<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Toggle navigation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>icon-bar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>icon-bar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>icon-bar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>navbar-brand<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Golang Website<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>collapse navbar-collapse<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>bs-example-navbar-collapse-1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>nav navbar-nav navbar-right<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">{{</span> <span class="token attr-name">if</span> <span class="token attr-name">eq</span> <span class="token attr-name">.currentPage</span> <span class="token attr-name">"login"</span> <span class="token attr-name">}}</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>active<span class="token punctuation">"</span></span> <span class="token attr-name">{{</span> <span class="token attr-name">end</span> <span class="token attr-name">}}</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/login<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Connexion<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">{{</span> <span class="token attr-name">if</span> <span class="token attr-name">eq</span> <span class="token attr-name">.currentPage</span> <span class="token attr-name">"signUp"</span> <span class="token attr-name">}}</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>active<span class="token punctuation">"</span></span> <span class="token attr-name">{{</span> <span class="token attr-name">end</span> <span class="token attr-name">}}</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/signup<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Inscription<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">{{</span> <span class="token attr-name">if</span> <span class="token attr-name">eq</span> <span class="token attr-name">.currentPage</span> <span class="token attr-name">"admin"</span> <span class="token attr-name">}}</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>active<span class="token punctuation">"</span></span> <span class="token attr-name">{{</span> <span class="token attr-name">end</span> <span class="token attr-name">}}</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/admin<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Admin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
        {{ if .userName }}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dropdown<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dropdown-toggle<span class="token punctuation">"</span></span> <span class="token attr-name">data-toggle</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dropdown<span class="token punctuation">"</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">aria-haspopup</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">aria-expanded</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>{{ .userName }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>caret<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dropdown-menu<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/logout<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Logout<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
        {{ end }}
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nav</span><span class="token punctuation">></span></span>

{{ if .success }}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>alert alert-success<span class="token punctuation">"</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>alert<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  {{ .success }}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>close<span class="token punctuation">"</span></span> <span class="token attr-name">data-dismiss</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>alert<span class="token punctuation">"</span></span> <span class="token attr-name">aria-label</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Close<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">aria-hidden</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token entity" title="&times;">&amp;times;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
{{ end }}

{{ if .warning }}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>alert alert-warning<span class="token punctuation">"</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>alert<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  {{ .warning }}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>close<span class="token punctuation">"</span></span> <span class="token attr-name">data-dismiss</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>alert<span class="token punctuation">"</span></span> <span class="token attr-name">aria-label</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Close<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">aria-hidden</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token entity" title="&times;">&amp;times;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
{{ end }}

{{ end }}</code></pre>
<h4 id="le-footer"><a href="#le-footer" aria-hidden="true"><span class="icon icon-link"></span></a>Le footer</h4>
<p>Puis un second template nommé "footer" dans le fichier "views/view_footer.html".</p>
<pre class="language-html"><code class="language-html">{{ define "footer" }}

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span>

{{ end }}</code></pre>
<h2 id="le-routeur"><a href="#le-routeur" aria-hidden="true"><span class="icon icon-link"></span></a>Le routeur</h2>
<p>Dans le fichier "main.go", on configure notre routeur dans la fonction principale.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"[chemin_du_projet]/controllers"</span>

    <span class="token string">"github.com/gin-gonic/gin"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Initialisation du routeur</span>
    r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Dossier des vues HTML</span>
    r<span class="token punctuation">.</span><span class="token function">LoadHTMLGlob</span><span class="token punctuation">(</span><span class="token string">"views/*"</span><span class="token punctuation">)</span>

    <span class="token comment">// Page d'accueil</span>
    r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> controllers<span class="token punctuation">.</span>IndexHandler<span class="token punctuation">)</span>

    <span class="token operator">/</span><span class="token operator">/</span> Page admin <span class="token punctuation">(</span>privée<span class="token punctuation">)</span>
    r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/admin"</span><span class="token punctuation">,</span> controllers<span class="token punctuation">.</span>AdminHandler<span class="token punctuation">)</span>

    <span class="token operator">/</span><span class="token operator">/</span> Page de connexion
    r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">,</span> controllers<span class="token punctuation">.</span>LoginHandlerForm<span class="token punctuation">)</span>
    r<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">,</span> controllers<span class="token punctuation">.</span>LoginHandler<span class="token punctuation">)</span>

    <span class="token operator">/</span><span class="token operator">/</span> Page de déconnexion
    r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">,</span> controllers<span class="token punctuation">.</span>LogoutHandler<span class="token punctuation">)</span>

    <span class="token operator">/</span><span class="token operator">/</span> Port du serveur
    r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":3000"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>On a donc 5 routes distinctes dont une pour notre futur formulaire de connexion. Le port utilisé est le "3000".</p>
<h2 id="middleware"><a href="#middleware" aria-hidden="true"><span class="icon icon-link"></span></a>Middleware</h2>
<p>On va avoir besoin de récupérer la valeur du cookie contenu dans le fichier "helpers/cookies.go".</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"[chemin_du_projet]/controllers"</span>
    <span class="token string">"[chemin_du_projet]/helpers"</span>

    <span class="token string">"github.com/gin-gonic/gin"</span>
<span class="token punctuation">)</span></code></pre>
<p>La route "admin" n'étant pas si privée que ça... on va donc créer un middleware qui va vérifier si le cookie de session n'existe pas alors on redirige l'utilisateur vers la page de connexion.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">Private</span><span class="token punctuation">(</span><span class="token punctuation">)</span> gin<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">Cookie</span><span class="token punctuation">(</span>helpers<span class="token punctuation">.</span>CookieSessionName<span class="token punctuation">)</span>

        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            c<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">"/login"</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">Abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Très important (sinon pas protégée avec curl -i http://localhost:3000/admin)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Remarque : la variable <code class="language-text">CookieSessionName</code> sera déclarée prochainement dans le helper "session.go" (vous pouvez commenter l'intérieur de la fonction <code class="language-text">Private()</code> pour le moment...).</p>
<p>Puis remplacez la route concernée en ajoutant le middleware.</p>
<pre class="language-go"><code class="language-go"><span class="token comment">// Page admin (privée)</span>
r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/admin"</span><span class="token punctuation">,</span> <span class="token function">Private</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> controllers<span class="token punctuation">.</span>AdminHandler<span class="token punctuation">)</span></code></pre>
<p>Il est également possible de créer un groupe de routes et d'attribuer ce middleware à tout ce groupe (vive le DRY :D).</p>
<pre class="language-go"><code class="language-go">admin <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"/admin"</span><span class="token punctuation">)</span> <span class="token comment">// Nom du groupe "admin" dont l'URI est "/admin"</span>
admin<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token function">Private</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token comment">// Utilisation du middleware Private()</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Page admin (privée)</span>
    admin<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> controllers<span class="token punctuation">.</span>AdminHandler<span class="token punctuation">)</span>
    <span class="token comment">// Autres routes dans "/admin"</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="helper"><a href="#helper" aria-hidden="true"><span class="icon icon-link"></span></a>Helper</h2>
<h3 id="les-cookies"><a href="#les-cookies" aria-hidden="true"><span class="icon icon-link"></span></a>Les cookies</h3>
<p>Ce helper va nous servir à créer un cookie de session, récupérer les infos de ce cookie, supprimer ce cookie mais également créer un cookie "flash" (sans durée), le supprimer sans oublier l'encodage et le décodage de sa valeur (pour les caractères spéciaux).</p>
<h4 id="initialisation-de-la-session"><a href="#initialisation-de-la-session" aria-hidden="true"><span class="icon icon-link"></span></a>Initialisation de la session</h4>
<p>Dans le fichier "helpers/cookies.go".</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> helpers

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"net/http"</span>
    <span class="token string">"net/url"</span>

    <span class="token string">"github.com/gin-gonic/gin"</span>
    <span class="token string">"github.com/gorilla/securecookie"</span>
<span class="token punctuation">)</span>

<span class="token comment">// Création du cookie sécurisé</span>
<span class="token keyword">var</span> cookieHandler <span class="token operator">=</span> securecookie<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>securecookie<span class="token punctuation">.</span><span class="token function">GenerateRandomKey</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> securecookie<span class="token punctuation">.</span><span class="token function">GenerateRandomKey</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// Nom du cookies de session</span>
<span class="token keyword">var</span> CookieSessionName <span class="token operator">=</span> <span class="token string">"session"</span></code></pre>
<p>On importe le package "net/http" pour travailler sur les cookies ainsi que "gorilla/securecookie" pour créer un cookie sécurisé que l'on déclare dans une variable nommée "cookieHandler" via la fonction <code class="language-text">securecookie.New()</code>. Le premier argument sert à définir une clef de hachage et le second à définir une clef de blocage. Quant aux packages "net/http" et "net/url", ils nous serviront pour les cookies flash.</p>
<h4 id="création-de-la-session"><a href="#cr%C3%A9ation-de-la-session" aria-hidden="true"><span class="icon icon-link"></span></a>Création de la session</h4>
<p>Puis on crée la fonction <code class="language-text">SetSession</code> pour définir un cookie à partir du nom de l'utilisateur.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">SetSession</span><span class="token punctuation">(</span>userName <span class="token builtin">string</span><span class="token punctuation">,</span> c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    value <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
        <span class="token string">"name"</span><span class="token punctuation">:</span> userName<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> encoded<span class="token punctuation">,</span> err <span class="token operator">:=</span> cookieHandler<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>CookieSessionName<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        cookie <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Cookie<span class="token punctuation">{</span>
            Name<span class="token punctuation">:</span>  CookieSessionName<span class="token punctuation">,</span>
            Value<span class="token punctuation">:</span> encoded<span class="token punctuation">,</span>
            Path<span class="token punctuation">:</span>  <span class="token string">"/"</span><span class="token punctuation">,</span>
            HttpOnly<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token comment">//Secure: true, SEULEMENT DISPONIBLE AVEC HTTPS ACTIVE</span>
        <span class="token punctuation">}</span>
        http<span class="token punctuation">.</span><span class="token function">SetCookie</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> cookie<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<ol>
<li>On stocke la valeur de l'utilisateur dans une variable (<code class="language-text">value</code>) ;</li>
<li>On encode notre cookie à partir du super cookie <code class="language-text">cookieHandler</code> dans la variable <code class="language-text">encoded</code> ;</li>
<li>Le cookie possède également un nom ("session" dans notre cas via la variable <code class="language-text">cookieSessionName</code>) ainsi qu'un chemin.</li>
</ol>
<p>Je vous conseille d'activer le flag "HttpOnly" pour des raisons de sécurité (cela empèche notamment l'exécution de la fonction JavaScript <code class="language-text">document.cookie</code>). Vous pouvez ajouter plus de sécurité si votre application est en HTTPS en définissant le cookie de session comme étant de type "secure" (<code class="language-text">Secure: true</code>).</p>
<h4 id="récupérer-la-valeur-de-lutilisateur"><a href="#r%C3%A9cup%C3%A9rer-la-valeur-de-lutilisateur" aria-hidden="true"><span class="icon icon-link"></span></a>Récupérer la valeur de l'utilisateur</h4>
<p>Puis on crée une autre fonction <code class="language-text">getUserName</code> pour récupérer le nom d'utilisateur stocké dans le cookie.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">GetUserName</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span>userName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> cookie<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">Cookie</span><span class="token punctuation">(</span>CookieSessionName<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        cookieValue <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">=</span> cookieHandler<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>CookieSessionName<span class="token punctuation">,</span> cookie<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cookieValue<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            userName <span class="token operator">=</span> cookieValue<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> userName
<span class="token punctuation">}</span></code></pre>
<p>Si le cookie existe, alors on récupère la valeur "name" du cookie que l'on retourne comme chaine de caractères.</p>
<h4 id="supprimer-la-session"><a href="#supprimer-la-session" aria-hidden="true"><span class="icon icon-link"></span></a>Supprimer la session</h4>
<p>Et une autre fonction <code class="language-text">ClearSession</code> pour détruire le cookie lors de la déconnexion.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">ClearSession</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cookie <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Cookie<span class="token punctuation">{</span>
        Name<span class="token punctuation">:</span>   CookieSessionName<span class="token punctuation">,</span>
        Value<span class="token punctuation">:</span>  <span class="token string">""</span><span class="token punctuation">,</span>
        Path<span class="token punctuation">:</span>   <span class="token string">"/"</span><span class="token punctuation">,</span>
        MaxAge<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    http<span class="token punctuation">.</span><span class="token function">SetCookie</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> cookie<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="encodage--décodage-de-valeurs"><a href="#encodage--d%C3%A9codage-de-valeurs" aria-hidden="true"><span class="icon icon-link"></span></a>Encodage / décodage de valeurs</h4>
<p>On a besoin d'encoder et de décoder les cookies pour accepter les caractères spéciaux.</p>
<pre class="language-go"><code class="language-go"><span class="token comment">// Encodage de la valeur du cookie</span>
<span class="token keyword">func</span> <span class="token function">encode</span><span class="token punctuation">(</span>value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    encode <span class="token operator">:=</span> <span class="token operator">&amp;</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">{</span>Path<span class="token punctuation">:</span> value<span class="token punctuation">}</span>
    <span class="token keyword">return</span> encode<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Décodage de la valeur du cookie</span>
<span class="token keyword">func</span> <span class="token function">decode</span><span class="token punctuation">(</span>value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    decode<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">QueryUnescape</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token keyword">return</span> decode
<span class="token punctuation">}</span></code></pre>
<h4 id="création-du-cookie-flash"><a href="#cr%C3%A9ation-du-cookie-flash" aria-hidden="true"><span class="icon icon-link"></span></a>Création du cookie "flash"</h4>
<p>On aura besoin de stocker des données dans un cookie provisoire.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">SetFlashCookie</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cookie <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Cookie<span class="token punctuation">{</span>
        Name<span class="token punctuation">:</span>   name<span class="token punctuation">,</span>
        Value<span class="token punctuation">:</span>  <span class="token function">encode</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
        Path<span class="token punctuation">:</span>   <span class="token string">"/"</span><span class="token punctuation">,</span>
        MaxAge<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    http<span class="token punctuation">.</span><span class="token function">SetCookie</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> cookie<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>On prend soin d'encoder la valeur du cookie. Avec un age très limité puisqu'il s'agit de données provisoires (message de succès, d'avertissement, d'erreur...).</p>
<h4 id="récupération-de-la-valeur-du-cookie-flash"><a href="#r%C3%A9cup%C3%A9ration-de-la-valeur-du-cookie-flash" aria-hidden="true"><span class="icon icon-link"></span></a>Récupération de la valeur du cookie "flash"</h4>
<p>On aura besoin de récupérer un cookie provisoire pour informer l'utilisateur.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">GetFlashCookie</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cookie<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">Cookie</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>

    <span class="token keyword">var</span> cookieValue <span class="token builtin">string</span>
    <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        cookieValue <span class="token operator">=</span> cookie<span class="token punctuation">.</span>Value
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        cookieValue <span class="token operator">=</span> cookieValue
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">decode</span><span class="token punctuation">(</span>cookieValue<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>On retourne la valeur... décodée.</p>
<h2 id="contôleurs"><a href="#cont%C3%B4leurs" aria-hidden="true"><span class="icon icon-link"></span></a>Contôleurs</h2>
<p>On va traiter nos 3 contrôleurs en commencant par le front puis la session et pour finir, le back.</p>
<h3 id="front"><a href="#front" aria-hidden="true"><span class="icon icon-link"></span></a>Front</h3>
<p>Dans le fichier "controllers/front.go".</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> controllers

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"[chemin_du_projet]/helpers"</span>

    <span class="token string">"github.com/gin-gonic/gin"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">IndexHandler</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    userName <span class="token operator">:=</span> helpers<span class="token punctuation">.</span><span class="token function">GetUserName</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>

    c<span class="token punctuation">.</span><span class="token function">HTML</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"view_index.html"</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
        <span class="token string">"userName"</span><span class="token punctuation">:</span>    userName<span class="token punctuation">,</span>
        <span class="token string">"currentPage"</span><span class="token punctuation">:</span> <span class="token string">"index"</span><span class="token punctuation">,</span>
        <span class="token string">"success"</span><span class="token punctuation">:</span>     helpers<span class="token punctuation">.</span><span class="token function">GetFlashCookie</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>On récupère (si elle existe), la valeur du cookie de session via la fonction <code class="language-text">GetUserName(c)</code>.</p>
<p>On affiche la page web dans "views/view_index.html".</p>
<pre class="language-html"><code class="language-html">{{ template "header" . }}

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Bienvenue :)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Vous êtes sur la partie front de ce site Web.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>

{{ template "footer" }}</code></pre>
<h3 id="session"><a href="#session" aria-hidden="true"><span class="icon icon-link"></span></a>Session</h3>
<p>On s'occupe de créer le formulaire "views/view_form.html" qui servira à la fois pour se connecter et pour s'inscrire.</p>
<pre class="language-html"><code class="language-html">{{ template "header" . }}

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>col-sm-6 col-sm-offset-3 form-box<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-top<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-top-left<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>{{ if eq .currentPage "login" }}Connexion{{ else }}Inscription{{ end }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-bottom<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>login-form<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-username<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Nom d'utilisateur<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Username...<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-username form-control<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-username<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-password<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Mot de passe<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Password...<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-password form-control<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-password<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn btn-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>{{ if eq .currentPage "login" }}Se connecter{{ else }}Valider mon inscription{{ end }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

{{ template "footer" }}</code></pre>
<p>Le plus important étant la présence des 2 champs obligatoire.</p>
<p>Dans le fichier "controllers/session.go".</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> controllers

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"[chemin_du_projet]/db"</span>
    <span class="token string">"[chemin_du_projet]/helpers"</span>

    <span class="token string">"github.com/gin-gonic/gin"</span>
<span class="token punctuation">)</span></code></pre>
<p>Puis dans notre contrôleur, on affiche notre formulaire dans la route <code class="language-text">LoginHandlerForm</code>.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">LoginHandlerForm</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Récupération du nom d'utilisateur pour le templating</span>
    userName <span class="token operator">:=</span> helpers<span class="token punctuation">.</span><span class="token function">GetUserName</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>

    c<span class="token punctuation">.</span><span class="token function">HTML</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"view_form.html"</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
        <span class="token string">"userName"</span><span class="token punctuation">:</span>    userName<span class="token punctuation">,</span>
        <span class="token string">"currentPage"</span><span class="token punctuation">:</span> <span class="token string">"login"</span><span class="token punctuation">,</span>
        <span class="token string">"warning"</span><span class="token punctuation">:</span>     helpers<span class="token punctuation">.</span><span class="token function">GetFlashCookie</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"warning"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>On récupère les données rentrées dans le formulaire (nom d'utilisateur et mot de passe) dans la route de type POST <code class="language-text">LoginHandlerForm</code>.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">LoginHandler</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Utilisateur concerné</span>
    user <span class="token operator">:=</span> db<span class="token punctuation">.</span>Users<span class="token punctuation">{</span>
        <span class="token string">"toto"</span><span class="token punctuation">,</span>
        <span class="token string">"password"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Récupération des champs</span>
    name <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">PostForm</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span>
    pass <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">PostForm</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> name <span class="token operator">!=</span> <span class="token string">""</span> <span class="token operator">&amp;&amp;</span> pass <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> name <span class="token operator">==</span> user<span class="token punctuation">.</span>Name <span class="token operator">&amp;&amp;</span> pass <span class="token operator">==</span> user<span class="token punctuation">.</span>Password <span class="token punctuation">{</span>
            helpers<span class="token punctuation">.</span><span class="token function">SetSession</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
            helpers<span class="token punctuation">.</span><span class="token function">SetFlashCookie</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"success"</span><span class="token punctuation">,</span> <span class="token string">"Bienvenue "</span><span class="token operator">+</span>user<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
            <span class="token comment">// Redirection vers la page protégée</span>
            c<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">"/admin"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Pas bon :(</span>
            helpers<span class="token punctuation">.</span><span class="token function">SetFlashCookie</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"warning"</span><span class="token punctuation">,</span> <span class="token string">"Identifiants incorrects"</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">"/login"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Si la correspondance est correcte alors on instancie le cookie de session et on redirige vers la page privée. Sinon on stocke un message d'avertissement dans un cookie de type "warning".</p>
<p>Dans ce contrôleur, il ne nous manque plus que la déconnexion avec la route <code class="language-text">LogoutHandler</code>.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">LogoutHandler</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    helpers<span class="token punctuation">.</span><span class="token function">ClearSession</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    helpers<span class="token punctuation">.</span><span class="token function">SetFlashCookie</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"success"</span><span class="token punctuation">,</span> <span class="token string">"Vous êtes désormais déconnecté(e)"</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>On supprime le cookie de session avec <code class="language-text">ClearSession</code> et on redirige vers la page d'accueil avec le message contenu dans le cookie flash.</p>
<h3 id="back"><a href="#back" aria-hidden="true"><span class="icon icon-link"></span></a>Back</h3>
<p>On crée notre magnifique page admin dans "views/views_admin.html".</p>
<pre class="language-html"><code class="language-html">{{ template "header" . }}

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Admin (page protégée)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>

{{ template "footer"}}</code></pre>
<p>Dans la fonction de la route <code class="language-text">AdminHandler</code> on appel la variable userName à partir de la fonction <code class="language-text">getUserName</code>.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> controllers

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"[chemin_du_projet]/helpers"</span>

    <span class="token string">"github.com/gin-gonic/gin"</span>
<span class="token punctuation">)</span>

<span class="token comment">// Admin</span>
<span class="token keyword">func</span> <span class="token function">AdminHandler</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Récupération du nom d'utilisateur pour le templating</span>
    userName <span class="token operator">:=</span> helpers<span class="token punctuation">.</span><span class="token function">GetUserName</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>

    c<span class="token punctuation">.</span><span class="token function">HTML</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"view_admin.html"</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
        <span class="token string">"userName"</span><span class="token punctuation">:</span>    userName<span class="token punctuation">,</span>
        <span class="token string">"currentPage"</span><span class="token punctuation">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span>
        <span class="token string">"success"</span><span class="token punctuation">:</span>     helpers<span class="token punctuation">.</span><span class="token function">GetFlashCookie</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"success"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="bcrypt"><a href="#bcrypt" aria-hidden="true"><span class="icon icon-link"></span></a>Bcrypt</h2>
<p>Présent dans de nombreux langage de programmation, Bcrypt est une fonction de hash. Contrairement à MD5, SHA-1, SHA-256, etc..., le mot de passe est haché différement et de ce fait est bien plus résistant aux attaques par force brute. Bcrypt utilise 3 critères :</p>
<ul>
<li><strong>cost</strong> : le coût souhaité de l'algorithme (suivant la puissance de la machine hébergeant le serveur) ;</li>
<li><strong>salt</strong> : sel de l'algorithme ;</li>
<li><strong>key</strong> : le mot de passe que l'on souhaite encoder.</li>
</ul>
<p>On aura donc besoin de hacher et de comparer.</p>
<h3 id="préparation-du-fichier"><a href="#pr%C3%A9paration-du-fichier" aria-hidden="true"><span class="icon icon-link"></span></a>Préparation du fichier</h3>
<p>Dans le fichier "helpers/password.go", on importe la librairie <code class="language-text">golang.org/x/crypto/bcrypt</code>.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> helpers

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"golang.org/x/crypto/bcrypt"</span>
<span class="token punctuation">)</span></code></pre>
<h3 id="hachage"><a href="#hachage" aria-hidden="true"><span class="icon icon-link"></span></a>Hachage</h3>
<pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">HashPassword</span><span class="token punctuation">(</span>password <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bytes<span class="token punctuation">,</span> err <span class="token operator">:=</span> bcrypt<span class="token punctuation">.</span><span class="token function">GenerateFromPassword</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">,</span> bcrypt<span class="token punctuation">.</span>DefaultCost<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span></code></pre>
<p>Dans la fonction <code class="language-text">hashPassword</code>, on passe en paramètre le mot de passe en clair. On retourne une chaine de caractères via la fonction <code class="language-text">GenerateFromPassword</code>. Le coût ("cost") est definit à 10 (le minimum étant 4 <code class="language-text">bcrypt.MinCost</code>, le maximum 31 <code class="language-text">bcrypt.MaxCost</code> et par défaut 10 <code class="language-text">bcrypt.DefaultCost</code>).</p>
<h3 id="vérification-par-comparaison"><a href="#v%C3%A9rification-par-comparaison" aria-hidden="true"><span class="icon icon-link"></span></a>Vérification par comparaison</h3>
<pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">CheckPasswordHash</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> hash <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    err <span class="token operator">:=</span> bcrypt<span class="token punctuation">.</span><span class="token function">CompareHashAndPassword</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> err <span class="token operator">==</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span></code></pre>
<p>On passe en paramètre le mot de passe et le mot de passe haché. On retourne un booléen via la fonction <code class="language-text">CompareHashAndPassword</code>.</p>
<h3 id="testons"><a href="#testons" aria-hidden="true"><span class="icon icon-link"></span></a>Testons</h3>
<p>Dans la fonction <code class="language-text">LoginHandler</code>, on modifie les lignes concernées.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">LoginHandler</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Utilisateur concerné</span>
    user <span class="token operator">:=</span> db<span class="token punctuation">.</span>Users<span class="token punctuation">{</span>
        <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"toto"</span><span class="token punctuation">,</span>
        <span class="token string">"password"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Mot de passe haché ("password")</span>
    hash<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> helpers<span class="token punctuation">.</span><span class="token function">HashPassword</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Password<span class="token punctuation">)</span>

    <span class="token comment">// Récupération des champs</span>
    name <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">PostForm</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span>
    pass <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">PostForm</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> name <span class="token operator">!=</span> <span class="token string">""</span> <span class="token operator">&amp;&amp;</span> pass <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> name <span class="token operator">==</span> user<span class="token punctuation">.</span>Name <span class="token operator">&amp;&amp;</span> helpers<span class="token punctuation">.</span><span class="token function">CheckPasswordHash</span><span class="token punctuation">(</span>pass<span class="token punctuation">,</span> hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            helpers<span class="token punctuation">.</span><span class="token function">SetSession</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
            helpers<span class="token punctuation">.</span><span class="token function">SetFlashCookie</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"success"</span><span class="token punctuation">,</span> <span class="token string">"Bienvenue "</span><span class="token operator">+</span>user<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
            <span class="token comment">// Redirection vers la page protégée</span>
            c<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">"/admin"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Pas bon :(</span>
            helpers<span class="token punctuation">.</span><span class="token function">SetFlashCookie</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"warning"</span><span class="token punctuation">,</span> <span class="token string">"Identifiants incorrects"</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">"/login"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="token-csrf"><a href="#token-csrf" aria-hidden="true"><span class="icon icon-link"></span></a>Token CSRF</h2>
<p>Le token CSRF (Cross-Site Request Forgery) permet de se protéger contre une faille bien connue, l'attaque XSS. Avec la génération de ce token aussi bien coté utilisateur que coté serveur, cela permet de renforcer la sécurité à moindres frais.</p>
<h3 id="coté-serveur"><a href="#cot%C3%A9-serveur" aria-hidden="true"><span class="icon icon-link"></span></a>Coté serveur</h3>
<p>Dans le fichier "main.go", importez le package officiel "net/http" et le package pour notre token "github.com/gorilla/csrf". Puis remplacez la ligne <code class="language-text">r.Run(&quot;:3000&quot;)</code> par la ligne ci-dessous.</p>
<pre class="language-go"><code class="language-go">http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">":3000"</span><span class="token punctuation">,</span>
    csrf<span class="token punctuation">.</span><span class="token function">Protect</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"32-byte-long-auth-key"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> csrf<span class="token punctuation">.</span><span class="token function">Secure</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>Il est important de spécifier le cookie de type Secure à false si HTTPS n'est pas activé (sinon le cookie ne fonctionnera pas).</p>
<p>Remarque : vous pouvez remplacez <code class="language-text">[]byte(&quot;32-byte-long-auth-key&quot;)</code> par securecookie.GenerateRandomKey(32) (après avoir importé le package "github.com/gorilla/securecookie").</p>
<p>Dans le fichier "controller/session.go", dans la fonction <code class="language-text">LoginHandlerForm</code>, ajoutez la propriété <code class="language-text">csrf.TemplateTag</code> avec pour valeur <code class="language-text">csrf.TemplateField(c.Request)</code>.</p>
<pre class="language-go"><code class="language-go">c<span class="token punctuation">.</span><span class="token function">HTML</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"view_form.html"</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
    <span class="token string">"userName"</span><span class="token punctuation">:</span>       userName<span class="token punctuation">,</span>
    <span class="token string">"currentPage"</span><span class="token punctuation">:</span>    <span class="token string">"login"</span><span class="token punctuation">,</span>
    <span class="token string">"warning"</span><span class="token punctuation">:</span>        helpers<span class="token punctuation">.</span><span class="token function">GetFlashCookie</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"warning"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    csrf<span class="token punctuation">.</span>TemplateTag<span class="token punctuation">:</span> csrf<span class="token punctuation">.</span><span class="token function">TemplateField</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Request<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>N'oubliez pas d'importer le package "github.com/gorilla/csrf" dans ce fichier.</p>
<h3 id="coté-client"><a href="#cot%C3%A9-client" aria-hidden="true"><span class="icon icon-link"></span></a>Coté client</h3>
<p>Dans le formulaire ("views/view_form"), ajoutez la valeur <code class="language-text">{{ .csrfField }}</code> avant la fermeture de la balise <code class="language-text">&lt;/form&gt;</code>. Cela aura pour effet d'ajouter un champ de type "hidden" dans le formulaire contenant le token comme valeur. En effet, la valeur <code class="language-text">csrf.TemplateField(c.Request)</code> produit le code ci-dessous.</p>
<pre class="language-go"><code class="language-go">fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">`&lt;input type="hidden" name="%s" value="%s">`</span><span class="token punctuation">,</span>
        <span class="token string">"myFieldName"</span><span class="token punctuation">,</span> <span class="token function">Token</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>Un exemple de rendu en HTML.</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gorilla.csrf.Token<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>JZ6ZacxKVbWWReZh90RgOtYgjzptXRL8NnpbCtI7a7P/R/oAtIWrgcUY5DgEDIiUmnMX3HfupUm3r4C3xci/IQ==<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code></pre>
<p>Si vous supprimez ou modifiez la valeur du champ, vous aurez le message suivant "Forbidden - CSRF token invalid" avec une erreur HTTP 403.</p>
<h2 id="base-de-données"><a href="#base-de-donn%C3%A9es" aria-hidden="true"><span class="icon icon-link"></span></a>Base de données</h2>
<p>Jusqu'à présent on a testé avec un seul compte utilisateur. On va s'assurer que les futurs utilisateurs puissent s'inscrire tout en ayant leur mot de passe haché dans la base de données et en prenant en compte l'unicité des comptes.</p>
<h3 id="connexion-à-sqlite"><a href="#connexion-%C3%A0-sqlite" aria-hidden="true"><span class="icon icon-link"></span></a>Connexion à SQLite</h3>
<p>Dans le fichier "db.go" présent dans le dossier "db", on importe l'ORM et le driver pour SQLite.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> db

<span class="token comment">// Les imports de librairies</span>
<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/jinzhu/gorm"</span>
    <span class="token boolean">_</span> <span class="token string">"github.com/mattn/go-sqlite3"</span>
<span class="token punctuation">)</span>

<span class="token comment">// La structure de données</span>
<span class="token keyword">type</span> Users <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Id       <span class="token builtin">int</span>    <span class="token string">`gorm:"AUTO_INCREMENT" form:"id"`</span>
    Name     <span class="token builtin">string</span> <span class="token string">`gorm:"not null;unique" form:"username"`</span> <span class="token comment">// Utilisateur unique!</span>
    Password <span class="token builtin">string</span> <span class="token string">`gorm:"not null" form:"password"`</span>
<span class="token punctuation">}</span>

<span class="token comment">// Connexion à la BDD SQLite</span>
<span class="token keyword">func</span> <span class="token function">InitDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
    <span class="token comment">// Ouverture de la connexion vers la BDD SQLite</span>
    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"sqlite3"</span><span class="token punctuation">,</span> <span class="token string">"./data.db"</span><span class="token punctuation">)</span>
    <span class="token comment">// Afficher les requêtes SQL (facultatif)</span>
    db<span class="token punctuation">.</span><span class="token function">LogMode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>

    <span class="token comment">// Création de la table "users"</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>db<span class="token punctuation">.</span><span class="token function">HasTable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Users<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        db<span class="token punctuation">.</span><span class="token function">CreateTable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Users<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        db<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"gorm:table_options"</span><span class="token punctuation">,</span> <span class="token string">"ENGINE=InnoDB"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateTable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Users<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> db
<span class="token punctuation">}</span></code></pre>
<p>On modifie la structure de données pour l'accorder avec l'ORM Gorm. Et on initialise la connexion au fichier SQLite "data.db".</p>
<h3 id="formulaire-dinscription"><a href="#formulaire-dinscription" aria-hidden="true"><span class="icon icon-link"></span></a>Formulaire d'inscription</h3>
<p>Dans le fichier "main.go", ajoutez les 2 routes ci-dessous.</p>
<pre class="language-go"><code class="language-go"><span class="token comment">// Page d'inscription</span>
r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/signup"</span><span class="token punctuation">,</span> controllers<span class="token punctuation">.</span>SignUpHandlerForm<span class="token punctuation">)</span>
r<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/signup"</span><span class="token punctuation">,</span> controllers<span class="token punctuation">.</span>SignUpHandler<span class="token punctuation">)</span></code></pre>
<p>Puis dans le contrôleur "session.go".</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">SignUpHandlerForm</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Récupération du nom d'utilisateur pour le templating</span>
    userName <span class="token operator">:=</span> helpers<span class="token punctuation">.</span><span class="token function">GetUserName</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>

    c<span class="token punctuation">.</span><span class="token function">HTML</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"view_form.html"</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
        <span class="token string">"userName"</span><span class="token punctuation">:</span>       userName<span class="token punctuation">,</span>
        <span class="token string">"currentPage"</span><span class="token punctuation">:</span>    <span class="token string">"signUp"</span><span class="token punctuation">,</span>
        <span class="token string">"warning"</span><span class="token punctuation">:</span>        helpers<span class="token punctuation">.</span><span class="token function">GetFlashCookie</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"warning"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        csrf<span class="token punctuation">.</span>TemplateTag<span class="token punctuation">:</span> csrf<span class="token punctuation">.</span><span class="token function">TemplateField</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Request<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>On utilise le même formulaire que pour la connexion sans oublier de générer le token CSRF.</p>
<p>Et la route de vérification de type "POST" <code class="language-text">SignUpHandler</code>.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">SignUpHandler</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> user db<span class="token punctuation">.</span>Users

    <span class="token keyword">if</span> c<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment">// Mot de passe haché</span>
        hash<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> helpers<span class="token punctuation">.</span><span class="token function">HashPassword</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Password<span class="token punctuation">)</span>
        user<span class="token punctuation">.</span>Password <span class="token operator">=</span> hash

        <span class="token comment">// Connexion à SQLite</span>
        dbmap <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">InitDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">defer</span> dbmap<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> err <span class="token operator">:=</span> dbmap<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"name = ?"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            helpers<span class="token punctuation">.</span><span class="token function">SetFlashCookie</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"warning"</span><span class="token punctuation">,</span> <span class="token string">"Inscription refusée, le nom d'utitlisateur "</span><span class="token operator">+</span>user<span class="token punctuation">.</span>Name<span class="token operator">+</span><span class="token string">" existe déjà"</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">"/signup"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Création de l'utilisateur</span>
            dbmap<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
            <span class="token comment">// Création du cookie de session</span>
            helpers<span class="token punctuation">.</span><span class="token function">SetSession</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">"/admin"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        helpers<span class="token punctuation">.</span><span class="token function">SetFlashCookie</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"warning"</span><span class="token punctuation">,</span> <span class="token string">"Champs non remplis"</span><span class="token punctuation">)</span>
        c<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">"/signup"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<ol>
<li>On récupère les données postées dans le formulaire d'inscription avec la fonction <code class="language-text">c.Bind</code> ;</li>
<li>On hash le mot de passe via la fonction <code class="language-text">hashPassword</code> ;</li>
<li>On s'assure que le nom d'utilisateur n'existe pas dans la BDD.</li>
<li>On se connecte à SQLite afin d'insérer les données avec la fonction <code class="language-text">Create</code> ;</li>
</ol>
<h3 id="connexion"><a href="#connexion" aria-hidden="true"><span class="icon icon-link"></span></a>Connexion</h3>
<p>Une fois le ou les utilisateurs créés, il faut modifier la route <code class="language-text">LoginHandler</code>.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">LoginHandler</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> user db<span class="token punctuation">.</span>Users

    <span class="token comment">// Binding du formulaire</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment">// Récupération du mdp en clair</span>
        clearPassword <span class="token operator">:=</span> user<span class="token punctuation">.</span>Password

        <span class="token comment">// Connexion au fichier SQLite</span>
        dbmap <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">InitDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">defer</span> dbmap<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> err <span class="token operator">:=</span> dbmap<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"name = ?"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>

            <span class="token comment">// Vérification du mdp</span>
            <span class="token keyword">if</span> helpers<span class="token punctuation">.</span><span class="token function">CheckPasswordHash</span><span class="token punctuation">(</span>clearPassword<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Création du cookie de session</span>
                helpers<span class="token punctuation">.</span><span class="token function">SetSession</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
                helpers<span class="token punctuation">.</span><span class="token function">SetFlashCookie</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"success"</span><span class="token punctuation">,</span> <span class="token string">"Bienvenue "</span><span class="token operator">+</span>user<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
                c<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">"/admin"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// MDP incorrect</span>
                helpers<span class="token punctuation">.</span><span class="token function">SetFlashCookie</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"warning"</span><span class="token punctuation">,</span> <span class="token string">"Mot de passe incorrect"</span><span class="token punctuation">)</span>
                c<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">"/login"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Nom d'utilisateur incorrect</span>
            helpers<span class="token punctuation">.</span><span class="token function">SetFlashCookie</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"warning"</span><span class="token punctuation">,</span> <span class="token string">"Nom d'utilisateur incorrect"</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">"/login"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Champs non remplis</span>
        helpers<span class="token punctuation">.</span><span class="token function">SetFlashCookie</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"warning"</span><span class="token punctuation">,</span> <span class="token string">"Champs non remplis"</span><span class="token punctuation">)</span>
        c<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">"/login"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<ol>
<li>On récupère les données postées dans le formulaire de connexion avec la fonction <code class="language-text">c.Bind</code> ;</li>
<li>On récupère le mot de passe en clair saisi par l'utilisateur ;</li>
<li>On se connecte à SQLite afin de trouver le nom d'utilisateur saisie ;</li>
<li>Avec la fonction <code class="language-text">checkPasswordHash</code> qui renvoie un booléen, on s'assure que le mot de passe en clair et le mot de passe haché corresponde bien ;</li>
<li>On instancie le cookie de session via la fonction <code class="language-text">SetSession</code> et on redirige l'utilisateur vers la page "admin".</li>
</ol>
<h3 id="afficher-tous-les-utilisateurs"><a href="#afficher-tous-les-utilisateurs" aria-hidden="true"><span class="icon icon-link"></span></a>Afficher tous les utilisateurs</h3>
<p>Dans la page admin, on va afficher la liste des utilisateurs dans un tableau.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">AdminHandler</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> users <span class="token punctuation">[</span><span class="token punctuation">]</span>db<span class="token punctuation">.</span>Users

    dbmap <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">InitDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> dbmap<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    dbmap<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>

    <span class="token comment">// Récupération du nom d'utilisateur pour le templating</span>
    userName <span class="token operator">:=</span> helpers<span class="token punctuation">.</span><span class="token function">GetUserName</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>

    c<span class="token punctuation">.</span><span class="token function">HTML</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"view_admin.html"</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
        <span class="token string">"userName"</span><span class="token punctuation">:</span>    userName<span class="token punctuation">,</span>
        <span class="token string">"currentPage"</span><span class="token punctuation">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span>
        <span class="token string">"users"</span><span class="token punctuation">:</span>       users<span class="token punctuation">,</span>
        <span class="token string">"success"</span><span class="token punctuation">:</span>     helpers<span class="token punctuation">.</span><span class="token function">GetFlashCookie</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>Pour que ce code fonctionne, importez le package interne "[chemin_du_projet]/db".</p>
<p>Puis dans la vue associée ("view_admin.html"), on boucle le tableau de données contenu dans la variable <code class="language-text">users</code> avec <code class="language-text">range</code>.</p>
<pre class="language-html"><code class="language-html">{{ template "header" . }}

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text-center<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Liste des utilisateurs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>table-responsive<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>table table-bordered<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">></span></span>Id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">></span></span>Name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">></span></span>Password (Bcrypt)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>
      {{ range $user := .users }}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{{ $user.Id }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{{ $user.Name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{{ $user.Password }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>
      {{ end }}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

{{ template "footer" }}</code></pre>
<h2 id="conclusion"><a href="#conclusion" aria-hidden="true"><span class="icon icon-link"></span></a>Conclusion</h2>
<p>La connexion et la déconnexion fonctionnent. Maintenant il faudrait offrir la possibilité à l'utilisateur de modifier son mot de passe et mettre en place un système de récupération du mot de passe par email.</p>
<h2 id="sources"><a href="#sources" aria-hidden="true"><span class="icon icon-link"></span></a>Sources</h2>
<ul>
<li><a href="https://github.com/gin-gonic/gin" target="_blank" rel="nofollow noopener noreferrer">https://github.com/gin-gonic/gin</a></li>
<li><a href="https://github.com/gorilla/securecookie" target="_blank" rel="nofollow noopener noreferrer">https://github.com/gorilla/securecookie</a></li>
<li><a href="https://github.com/gorilla/csrf" target="_blank" rel="nofollow noopener noreferrer">https://github.com/gorilla/csrf</a></li>
<li><a href="https://github.com/jinzhu/gorm" target="_blank" rel="nofollow noopener noreferrer">https://github.com/jinzhu/gorm</a></li>
<li><a href="https://gowebexamples.github.io/sessions" target="_blank" rel="nofollow noopener noreferrer">https://gowebexamples.github.io/sessions</a></li>
<li><a href="https://gowebexamples.github.io/password-hashing" target="_blank" rel="nofollow noopener noreferrer">https://gowebexamples.github.io/password-hashing</a></li>
<li><a href="http://www.alexedwards.net/blog/simple-flash-messages-in-golang" target="_blank" rel="nofollow noopener noreferrer">http://www.alexedwards.net/blog/simple-flash-messages-in-golang</a></li>
<li><a href="https://golang.org/pkg/html/template" target="_blank" rel="nofollow noopener noreferrer">https://golang.org/pkg/html/template</a></li>
<li><a href="https://fr.wikipedia.org/wiki/Bcrypt" target="_blank" rel="nofollow noopener noreferrer">https://fr.wikipedia.org/wiki/Bcrypt</a></li>
</ul>
</article></div><footer class="text-white mt-4"><ul class="nav nav-pills justify-content-center"><li><a href="https://github.com/etienner" target="_blank" class="nav-link">Github</a></li><li><a href="https://medium.com/@etiennerouzeaud" target="_blank" class="nav-link">Medium</a></li><li><a href="https://twitter.com/etiennerouzeaud" target="_blank" class="nav-link">Twitter</a></li></ul></footer></div>
    <script src="/assets/js/app.06de8649.js" defer></script><script src="/assets/js/page--src--templates--post-vue.6a9fe53b.js" defer></script>
  </body>
</html>
